<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SL璽愛</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- HTML5 QRCode -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden {
            display: none !important;
        }
        body {
            font-family: '微軟正黑體', sans-serif;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f5f5f5;
        }

        /* 後台管理介面樣式 */
        #staffSection {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            background-color: #fff;
        }
        
        #staffSection .search-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 100%;
        }

        #staffSection .search-section h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            text-align: center;
        }

        #staffSection .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #staffSection .search-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #staffSection .search-form label {
            font-size: 16px;
            color: #333;
        }

        #staffSection .search-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        #staffSection .search-form .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #staffSection .search-form button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background-color: #4285f4;
            color: white;
        }

        #staffSection .search-form button:hover {
            background-color: #357abd;
        }

        #staffSection .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #staffSection .info-table th,
        #staffSection .info-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #staffSection .info-table th {
            background-color: #f5f5f5;
            font-weight: normal;
            width: 120px;
        }

        #staffSection .action-btn {
            padding: 5px 15px;
            margin: 5px;
            border: none;
            cursor: pointer;
        }

        #staffSection #visitHistory {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        #staffSection #visitHistory p {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        #staffLogoutBtn {
            margin-top: 20px;
            padding: 5px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            background-color: #dc3545 !important;
            color: white;
        }

        /* 會員介面樣式 */
        #customerSection {
            max-width: 100%;
            padding: 10px;
        }

        #customerSection .form-group {
            margin: 20px 0;
        }

        #customerSection .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #customerSection .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }

        #customerSection button {
            width: 100%;
            padding: 15px 25px;
            font-size: 16px;
            margin: 10px 0;
        }

        /* 通用樣式 */
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #357abd;
        }

        .info-table {
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-table th, .info-table td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
        }

        /* 登入介面樣式 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 16px;
        }

        .google-login-btn img {
            width: 24px;
            margin-right: 10px;
        }

        /* 條碼顯示樣式 */
        .barcode-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .barcode-item {
            margin: 20px 0;
            text-align: center;
        }

        .barcode-item svg {
            max-width: 100%;
            height: auto;
        }

        /* 刪除確認對話框樣式 */
        .modal {
            display: none;
        }

        /* 響應式設計（僅針對會員介面） */
        @media (max-width: 480px) {
            #customerSection {
                padding: 10px;
            }

            #customerSection .form-group label {
                font-size: 14px;
            }

            #customerSection .form-group input {
                font-size: 16px;
                padding: 10px;
            }

            #customerSection button {
                padding: 12px 20px;
                font-size: 16px;
            }

            .login-container {
                padding: 20px;
            }

            .login-container h2 {
                font-size: 20px;
            }
        }

        /* 載入動畫樣式 */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #fff;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-text {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .loading-text img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            max-width: 100vw;
            max-height: 100vh;
        }

        /* 自定義提示框樣式 */
        .custom-alert {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            text-align: center;
            min-width: 300px;
            border: 1px solid #e0e0e0;
        }

        .custom-alert .message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .custom-alert .confirm-btn {
            padding: 10px 30px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-alert .confirm-btn:hover {
            background-color: #357abd;
        }

        .alert-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2999;
        }

        /* 新增會員收合按鈕樣式 */
        .toggle-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 100%;
        }

        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .toggle-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .toggle-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .toggle-content.expanded {
            max-height: 1000px;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        /* 會員清單表格樣式 */
        .member-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
        }

        .member-table th,
        .member-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .member-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .member-table tr:hover {
            background-color: #f5f5f5;
        }

        .member-table .action-column {
            width: 100px;
            text-align: center;
        }

        .view-btn {
            padding: 5px 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-btn:hover {
            background-color: #357abd;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 5px 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            color: #333;
        }

        .pagination button:hover {
            background-color: #f5f5f5;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination button.active {
            background-color: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        /* 報表分析相關樣式 */
        .report-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: white;
            z-index: 1000;
        }

        .report-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .report-loading img {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }

        .report-content {
            width: 100%;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
            gap: 20px;
        }

        .report-header h2 {
            margin: 0;
            font-size: 24px;
            order: 1;
        }

        .report-close-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            order: 2;
            margin-right: 20px;
        }

        .report-close-btn:hover {
            background-color: #d32f2f;
        }

        .report-filters {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .report-filters select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .report-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            flex: 1;
        }

        .chart-container {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- 自定義提示框 -->
    <div class="alert-overlay"></div>
    <div class="custom-alert">
        <div class="message"></div>
        <button class="confirm-btn">確定</button>
    </div>

    <!-- 載入動畫 -->
    <div class="loading-overlay">
        <div class="loading-text">
            <img src="SystemProcessing.bmp" alt="系統處理中">
        </div>
    </div>

    <!-- 登入區域 -->
    <div id="loginSection" class="login-overlay">
        <div class="login-container">
            <h2>SL璽愛旅店<h2>
            <div id="adminLoginSection" class="hidden">
                <div class="form-group">
                    <label for="email">電子郵件：</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼：</label>
                    <input type="password" id="password" required>
                </div>
                <button id="emailLogin">登入（輸入完請按這個）</button>
            </div>
            <div id="memberLoginSection">
                <p>請使用 Google 帳號登入以使用會員功能</p>
                <button id="googleLogin" class="google-login-btn">
                    <img src="https://www.google.com/favicon.ico" alt="Google" style="width: 20px; margin-right: 10px;">
                    使用 Google 登入
                </button>
            </div>
            <div class="admin-login-hint">
                <button id="showAdminLogin" class="text-button">管理員登入</button>
            </div>
        </div>
    </div>

    <!-- 會員資料填寫區域 -->
    <div id="customerSection" class="hidden">
        <h2>會員資料（customer）</h2>
        <div class="info-message">請先完整填寫會員資料才能取得會員條碼 Key your customer data to get your barcode</div>
        <form id="memberInfoForm">
            <div class="form-group">
                <label>電子郵件（email）：</label>
                <span id="memberEmailDisplay"></span>
            </div>
            <div class="form-group">
                <label for="name">姓名（name）</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="idNumber">證件號碼（idNumber）</label>
                <input type="text" id="idNumber" required>
            </div>
            <div class="form-group">
                <label for="birthDate">出生年月日（birthDate）</label>
                <input type="date" id="birthDate" required>
            </div>
            <div class="form-group">
                <label for="phone">電話號碼（phone）</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label for="nationality">國籍（nationality）</label>
                <input type="text" id="nationality" required>
            </div>
            <button type="submit" class="submit-btn">儲存資料（save）</button>
        </form>
        <div id="barcodeDisplay" class="hidden">
            <h3>您的會員條碼（barcode）</h3>
            <p class="barcode-notice">請妥善保存此條碼，每次到訪時請出示（show）</p>
            <div class="barcode-container">
                <div class="barcode-number">條碼編號：<span id="memberBarcodeDisplay"></span></div>
                <div id="barcodeContainer"></div>
            </div>
        </div>
        <button id="logoutBtn">登出（logout）</button>
    </div>

    <!-- 店員介面 -->
    <div id="staffSection" class="hidden">
        <h2>後台</h2>
        
        <!-- 功能按鈕區域 -->
        <div class="toggle-section">
            <div class="button-group" style="margin: 15px 0; display: flex; gap: 15px;">
                <button onclick="exportMemberData()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #4CAF50; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">📊</span>
                    備份匯出
                </button>
                <button onclick="importMemberData()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #FF9800; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">📥</span>
                    備份導入
                </button>
                <button onclick="showScheduleDialog()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #2196F3; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">⏰</span>
                    設定備份提醒時間
                </button>
                <button onclick="showReportDialog()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #9C27B0; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">📈</span>
                    情報分析
                </button>
            </div>
        </div>
        
        <!-- 會員清單區域 -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleMemberList()">
                <h2>會員清單</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="toggle-content" id="memberListContent">
                <div class="member-list-container">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th>會員條碼</th>
                                <th>姓名</th>
                                <th>電話</th>
                                <th>到訪次數</th>
                                <th class="action-column">操作</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody">
                            <!-- 會員資料將在這裡動態載入 -->
                        </tbody>
                    </table>
                    <div class="pagination" id="memberListPagination">
                        <!-- 分頁按鈕將在這裡動態載入 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 新增會員區域 -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleNewMemberForm()">
                <h2>新增會員</h2>
                <span class="toggle-icon">▼</span>
            </div>
            <div class="toggle-content" id="newMemberForm">
                <div class="search-form">
                    <div class="form-group">
                        <label for="newMemberEmail">電子郵件：</label>
                        <input type="email" id="newMemberEmail" placeholder="請輸入會員電子郵件">
                    </div>
                    <div class="form-group">
                        <label for="newMemberName">姓名：</label>
                        <input type="text" id="newMemberName" placeholder="請輸入會員姓名">
                    </div>
                    <div class="form-group">
                        <label for="newMemberIdNumber">證件號碼：</label>
                        <input type="text" id="newMemberIdNumber" placeholder="請輸入證件號碼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberBirthDate">出生年月日：</label>
                        <input type="date" id="newMemberBirthDate">
                    </div>
                    <div class="form-group">
                        <label for="newMemberPhone">電話號碼：</label>
                        <input type="tel" id="newMemberPhone" placeholder="請輸入電話號碼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberNationality">國籍：</label>
                        <input type="text" id="newMemberNationality" placeholder="請輸入國籍">
                    </div>
                    <div class="button-group">
                        <button onclick="addNewMember()">新增會員</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 搜尋區域 -->
        <div class="search-section">
            <h2>會員搜尋</h2>
            <div class="search-form">
                <div class="form-group">
                    <label for="searchBarcode">會員條碼：</label>
                    <input type="text" id="searchBarcode" placeholder="請輸入會員條碼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="form-group">
                    <label for="searchIdNumber">證件號碼：</label>
                    <input type="text" id="searchIdNumber" placeholder="請輸入證件號碼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="button-group">
                    <button onclick="searchMember()">搜尋</button>
                    <button id="addVisitBtn" disabled onclick="addVisit()">增加到訪次數</button>
                </div>
            </div>
        </div>

        <!-- 會員詳細資料 -->
        <div id="customerInfo" class="hidden">
            <h3>會員詳細資料</h3>
            <table class="info-table">
                <tr><th>會員條碼</th><td id="customerBarcode"></td></tr>
                <tr><th>姓名</th><td id="customerName"></td></tr>
                <tr><th>電話</th><td id="customerPhone"></td></tr>
                <tr><th>電子郵件</th><td id="customerEmail"></td></tr>
                <tr><th>證件號碼</th><td id="customerIdNumber"></td></tr>
                <tr><th>出生年月日</th><td id="customerBirthDate"></td></tr>
                <tr><th>國籍</th><td id="customerNationality"></td></tr>
                <tr><th>到訪次數</th><td id="visitCount"></td></tr>
            </table>
            <div style="margin: 20px 0;">
                <button class="action-btn delete-btn" onclick="showDeleteConfirm()">刪除會員</button>
            </div>
            <h4>到訪記錄</h4>
            <div id="visitHistory"></div>
        </div>

        <button id="staffLogoutBtn">登出</button>
    </div>

    <!-- 報表分析對話框 -->
    <div class="report-dialog">
        <div class="report-loading">
            <img src="SystemProcessing.bmp" alt="載入中">
        </div>
        <div class="report-content">
            <div class="report-header">
                <h2>情報分析</h2>
                <button class="report-close-btn" onclick="hideReportDialog()">關閉</button>
            </div>
            <div class="report-filters">
                <div class="form-group">
                    <label for="reportDateRange">選擇日期範圍：</label>
                    <select id="reportDateRange" onchange="updateReports()">
                        <option value="7">最近7天</option>
                        <option value="14">最近14天</option>
                        <option value="30">最近30天</option>
                        <option value="90">最近90天</option>
                        <option value="180">最近180天</option>
                        <option value="365">最近1年</option>
                        <option value="730">最近2年</option>
                    </select>
                </div>
            </div>
            <div class="report-charts">
                <div class="chart-container">
                    <h3>會員成長趨勢</h3>
                    <canvas id="memberGrowthChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>到訪頻率分析</h3>
                    <canvas id="visitFrequencyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>會員活躍度分析</h3>
                    <canvas id="memberActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加音效元素 -->
    <audio id="reminderSound" preload="auto">
        <source src="SystemMessage_warning1.wav" type="audio/wav">
    </audio>
    <audio id="exportSound" preload="auto">
        <source src="SystemMessage_warning2.wav" type="audio/wav">
    </audio>

    <!-- 導入數據對話框 -->
    <div id="importDialog" class="hidden" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; z-index: 1000;">
        <div class="report-content">
            <div class="report-header">
                <h2>導入備份</h2>
                <button class="report-close-btn" onclick="hideImportDialog()">關閉</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label for="importFile">選擇 TSV 檔案：</label>
                    <input type="file" id="importFile" accept=".tsv" style="width: 100%; padding: 10px; margin: 10px 0;">
                </div>
                <div class="form-group">
                    <label>導入選項：</label>
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="updateExisting" checked>
                        <label for="updateExisting">更新已存在的會員資料</label>
                    </div>
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="createNew" checked>
                        <label for="createNew">創建新會員</label>
                    </div>
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="startImport()" style="width: 100%; padding: 15px; font-size: 16px;">開始導入</button>
                </div>
                <div id="importProgress" style="margin-top: 20px; display: none;">
                    <div style="width: 100%; background-color: #f0f0f0; border-radius: 4px;">
                        <div id="importProgressBar" style="width: 0%; height: 20px; background-color: #4CAF50; border-radius: 4px; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="importStatus" style="text-align: center; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAaCC1v4YhL8d1sGjDgjIKumMbzzeydB9M",
            authDomain: "vipproject-1daf7.firebaseapp.com",
            projectId: "vipproject-1daf7",
            storageBucket: "vipproject-1daf7.appspot.com",
            messagingSenderId: "38611408907",
            appId: "1:38611408907:web:91ba08924cc33d8758cf0e",
            measurementId: "G-FSE2CSC7NP"
        };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase 初始化完成');
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 檢查是否為管理員
        async function checkIfStaff(uid) {
            console.log('正在檢查管理員權限，用戶 UID:', uid);
            try {
                // 檢查是否為指定的管理員 UID
                if (uid === 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    console.log('使用預設管理員 UID');
                    return true;
                }

                const officialRef = db.collection('official').doc('data');
                const officialDoc = await officialRef.get();
                
                if (!officialDoc.exists) {
                    console.log('official/data 文件不存在，正在創建...');
                    try {
                        // 創建文件並設置指定的 UID 為管理員
                        await officialRef.set({
                            staffs: {
                                't4R9VmALi2SW2fTITmBAtlYDzq32': true
                            }
                        });
                        console.log('成功創建管理員文件');
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    } catch (createError) {
                        console.error('創建管理員文件時發生錯誤:', createError);
                        // 如果是指定的管理員 UID，即使創建失敗也返回 true
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    }
                }

                const data = officialDoc.data();
                console.log('獲取到的管理員資料:', data);
                
                if (!data || !data.staffs) {
                    console.log('管理員資料格式不正確，檢查是否為預設管理員');
                    return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                }

                const isStaff = data.staffs[uid] === true || uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                console.log('用戶是否為管理員:', isStaff);
                return isStaff;
            } catch (error) {
                console.error('檢查管理員權限時發生錯誤:', error);
                // 如果發生錯誤，檢查是否為預設管理員 UID
                return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
            }
        }

        // 電子郵件登入
        document.getElementById('emailLogin').addEventListener('click', () => {
            console.log('點擊管理員登入按鈕');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log('準備登入，電子郵件:', email);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((result) => {
                    console.log('管理員登入成功', result);
                    hideLoginInterface();
                })
                .catch((error) => {
                    console.error('管理員登入錯誤:', error);
                    alert('登入失敗：' + error.message);
                });
        });

        // Google 登入
        document.getElementById('googleLogin').addEventListener('click', () => {
            console.log('開始 Google 登入流程');
            const provider = new firebase.auth.GoogleAuthProvider();
            // 設置登入視窗的配置
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('登入成功', result);
                })
                .catch((error) => {
                    console.error('登入錯誤:', error);
                    // 如果是彈出視窗被封鎖，嘗試使用重定向方式
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
                        console.log('嘗試使用重定向方式登入');
                        return auth.signInWithRedirect(provider);
                    }
                    alert('登入失敗：' + error.message);
                });
        });

        // 監聽登入狀態
        auth.onAuthStateChanged(async (user) => {
            console.log('登入狀態變更:', user ? '已登入' : '未登入');
            if (user) {
                try {
                    console.log('用戶資訊:', user);
                    hideLoginInterface();  // 登入成功後隱藏登入介面
                    // 檢查是否為管理員
                    const isStaff = await checkIfStaff(user.uid);
                    
                    if (isStaff) {
                        // 顯示管理員介面
                        showStaffInterface();
                        const savedTime = localStorage.getItem('reminderTime');
                        if (savedTime) {
                            setupReminder(savedTime);
                        }
                    } else {
                        // 檢查會員資料
                        const userProfileRef = db.collection('users').doc(user.uid)
                            .collection('data').doc('profile');
                        const userProfile = await userProfileRef.get();

                        if (!userProfile.exists) {
                            // 建立新會員資料
                            const timestamp = Date.now();
                            const barcode = `MEM${timestamp}`;
                            
                            // 先建立 profile 文檔
                            await userProfileRef.set({
                                role: 'customer',
                                email: user.email,
                                barcode: barcode,
                                name: '',
                                idNumber: '',
                                birthDate: '',
                                phone: '',
                                nationality: '',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                isInfoComplete: false
                            });

                            console.log('新會員資料已建立:', {
                                uid: user.uid,
                                barcode: barcode,
                                email: user.email
                            });
                        }
                        
                        showCustomerInterface(userProfile.exists ? userProfile.data() : 
                            (await userProfileRef.get()).data());
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert('登入成功');
                }
            } else {
                showLoginInterface();
            }
        });

        // 顯示會員介面
        function showCustomerInterface(userData) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.remove('hidden');
            document.getElementById('staffSection').classList.add('hidden');

            // 顯示基本資訊
            document.getElementById('memberEmailDisplay').textContent = userData.email;

            // 填入現有資料
            if (userData.isInfoComplete) {
                document.getElementById('name').value = userData.name || '';
                document.getElementById('idNumber').value = userData.idNumber || '';
                document.getElementById('birthDate').value = userData.birthDate || '';
                document.getElementById('phone').value = userData.phone || '';
                document.getElementById('nationality').value = userData.nationality || '';
                
                // 只有在資料完整的情況下才顯示條碼
                showBarcode(userData.barcode);
            } else {
                document.getElementById('barcodeDisplay').classList.add('hidden');
            }
        }

        // 修改條碼顯示函數，同時顯示兩種格式
        function showBarcode(barcode) {
            const barcodeDisplay = document.getElementById('barcodeDisplay');
            document.getElementById('memberBarcodeDisplay').textContent = barcode;
            
            // 創建兩個 canvas 元素，分別顯示 CODE128 和 CODE39
            const barcodeContainer = document.getElementById('barcodeContainer');
            barcodeContainer.innerHTML = `
                <div class="barcode-item">
                    <p>CODE128 格式</p>
                    <svg id="memberBarcode128"></svg>
                </div>
                <div class="barcode-item">
                    <p>CODE39 格式</p>
                    <svg id="memberBarcode39"></svg>
                </div>
            `;
            
            // 生成 CODE128 條碼
            JsBarcode("#memberBarcode128", barcode, {
                format: "CODE128",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            // 生成 CODE39 條碼
            JsBarcode("#memberBarcode39", barcode, {
                format: "CODE39",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            barcodeDisplay.classList.remove('hidden');
        }

        // 顯示管理員介面
        function showStaffInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.remove('hidden');

            // 綁定搜尋功能
            document.getElementById('searchBtn').addEventListener('click', searchMember);
        }

        // 自定義提示框函數
        function showCustomAlert(message) {
            hideLoading(); // 先隱藏加載動畫
            
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            const confirmBtn = customAlert.querySelector('.confirm-btn');

            messageElement.textContent = message;
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';

            return new Promise((resolve) => {
                confirmBtn.onclick = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    resolve();
                };
            });
        }

        // 修改搜尋會員函數中的提示
        async function searchMember() {
            const barcode = document.getElementById('searchBarcode').value.trim();
            const idNumber = document.getElementById('searchIdNumber').value.trim();

            if (!barcode && !idNumber) {
                await showCustomAlert('請輸入會員條碼或證件號碼');
                return;
            }

            try {
                showLoading();
                console.log('開始搜尋會員:', { barcode, idNumber });
                
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                console.log('搜尋結果數量:', querySnapshot.size);

                document.getElementById('searchBarcode').value = '';
                document.getElementById('searchIdNumber').value = '';

                const foundDoc = querySnapshot.docs.find(doc => {
                    const data = doc.data();
                    if (barcode) {
                        return data.barcode === barcode;
                    }
                    if (idNumber) {
                        return data.idNumber === idNumber;
                    }
                    return false;
                });

                if (!foundDoc) {
                    console.log('未找到會員');
                    await showCustomAlert('找不到此會員');
                    document.getElementById('addVisitBtn').disabled = true;
                    return;
                }

                const userData = foundDoc.data();
                const userId = foundDoc.ref.parent.parent.id;

                console.log('找到會員:', {
                    userId: userId,
                    barcode: userData.barcode,
                    name: userData.name,
                    idNumber: userData.idNumber
                });

                // 啟用增加到訪次數按鈕並重新綁定事件
                const addVisitBtn = document.getElementById('addVisitBtn');
                addVisitBtn.disabled = false;
                addVisitBtn.onclick = function() {
                    console.log('增加到訪次數按鈕被點擊（從搜尋結果）');
                    addVisit();
                };
                
                // 儲存當前搜尋到的會員資料
                window.currentSearchedMember = {
                    userId: userId,
                    barcode: userData.barcode
                };

                // 顯示會員詳情
                await viewMemberDetails(userId);
                
                console.log('搜尋流程完成');
            } catch (error) {
                console.error('搜尋會員時發生錯誤:', error);
                await showCustomAlert('搜尋失敗：' + error.message);
                document.getElementById('addVisitBtn').disabled = true;
            } finally {
                hideLoading();
            }
        }

        // 查看會員詳情
        async function viewMemberDetails(userId) {
            try {
                showLoading(); // 顯示載入動畫
                // 先確認是否為管理員
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('權限不足');
                }

                console.log('開始查看會員詳情，用戶 ID:', userId);

                // 使用 UID 直接查詢
                const profileSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('data')
                    .doc('profile')
                    .get();

                if (!profileSnapshot.exists) {
                    console.log('未找到會員詳情');
                    alert('找不到會員詳情');
                    return;
                }

                const userData = profileSnapshot.data();

                console.log('開始載入會員詳細資訊');

                // 獲取訪問記錄
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .orderBy('timestamp', 'desc')
                    .get();

                console.log('取得到訪記錄，次數:', visitsSnapshot.size);

                // 顯示會員資訊
                document.getElementById('customerBarcode').textContent = userData.barcode || '';
                document.getElementById('customerName').textContent = userData.name || '';
                document.getElementById('customerPhone').textContent = userData.phone || '';
                document.getElementById('customerEmail').textContent = userData.email || '';
                document.getElementById('customerIdNumber').textContent = userData.idNumber || '';
                document.getElementById('customerBirthDate').textContent = userData.birthDate || '';
                document.getElementById('customerNationality').textContent = userData.nationality || '';
                document.getElementById('visitCount').textContent = visitsSnapshot.size;

                // 顯示訪問記錄
                const visitHistory = document.getElementById('visitHistory');
                visitHistory.innerHTML = '';
                visitsSnapshot.forEach(visit => {
                    const visitDate = visit.data().timestamp.toDate();
                    const p = document.createElement('p');
                    p.textContent = visitDate.toLocaleString('zh-TW');
                    visitHistory.appendChild(p);
                });

                document.getElementById('customerInfo').classList.remove('hidden');
                console.log('會員詳情顯示完成');
            } catch (error) {
                console.error('載入會員詳情時發生錯誤:', error);
                if (error.code === 'permission-denied') {
                    alert('您沒有權限查看會員詳情。請確保您已登入管理員帳號。');
                } else {
                    alert('載入會員詳情失敗：' + error.message);
                }
            } finally {
                hideLoading(); // 隱藏載入動畫
            }
        }

        // 顯示登入介面
        function showLoginInterface() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.add('hidden');
        }

        // 隱藏登入介面
        function hideLoginInterface() {
            document.getElementById('loginSection').style.display = 'none';
        }

        // 處理會員資料表單提交
        document.getElementById('memberInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            try {
                showLoading();
                const userData = {
                    name: document.getElementById('name').value,
                    idNumber: document.getElementById('idNumber').value,
                    birthDate: document.getElementById('birthDate').value,
                    phone: document.getElementById('phone').value,
                    nationality: document.getElementById('nationality').value,
                    isInfoComplete: true
                };

                await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .update(userData);

                // 獲取完整的用戶資料
                const userProfile = await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .get();

                // 顯示條碼
                showBarcode(userProfile.data().barcode);
                
                await showCustomAlert('資料已成功儲存！現在您可以看到您的會員條碼。');
            } catch (error) {
                console.error("Error saving data:", error);
                await showCustomAlert('儲存資料時發生錯誤');
            } finally {
                hideLoading();
            }
        });

        // 登出按鈕
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('staffLogoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // 顯示管理員登入區域
        document.getElementById('showAdminLogin').addEventListener('click', () => {
            console.log('點擊顯示管理員登入區域按鈕');
            const adminLoginSection = document.getElementById('adminLoginSection');
            const memberLoginSection = document.getElementById('memberLoginSection');
            
            // 切換管理員登入區域的顯示狀態
            adminLoginSection.classList.toggle('hidden');
            
            // 如果顯示管理員登入，則隱藏會員登入
            if (!adminLoginSection.classList.contains('hidden')) {
                memberLoginSection.classList.add('hidden');
            } else {
                memberLoginSection.classList.remove('hidden');
            }
            
            console.log('管理員登入區域顯示狀態:', !adminLoginSection.classList.contains('hidden'));
        });

        // 刪除會員相關變數
        let currentDeletingMember = null;

        // 顯示刪除確認對話框
        async function showDeleteConfirm() {
            const memberName = document.getElementById('customerName').textContent;
            const memberBarcode = document.getElementById('customerBarcode').textContent;
            currentDeletingMember = {
                barcode: memberBarcode,
                name: memberName
            };
            
            // 使用自定義提示框
            const confirmDelete = await new Promise(resolve => {
                const alertOverlay = document.querySelector('.alert-overlay');
                const customAlert = document.querySelector('.custom-alert');
                const messageElement = customAlert.querySelector('.message');
                const confirmBtn = customAlert.querySelector('.confirm-btn');
                
                messageElement.innerHTML = `確定要刪除會員 ${memberName} 嗎？<br>此操作無法復原。`;
                alertOverlay.style.display = 'block';
                customAlert.style.display = 'block';
                
                // 移除現有的取消按鈕（如果存在）
                const existingCancelBtn = customAlert.querySelector('.cancel-btn');
                if (existingCancelBtn) {
                    existingCancelBtn.remove();
                }
                
                // 添加取消按鈕
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '取消';
                cancelBtn.className = 'confirm-btn cancel-btn';
                cancelBtn.style.marginLeft = '10px';
                cancelBtn.style.backgroundColor = '#6c757d';
                confirmBtn.parentNode.appendChild(cancelBtn);
                
                confirmBtn.textContent = '確認刪除';
                confirmBtn.style.backgroundColor = '#dc3545';
                
                // 移除之前的事件監聽器
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                const cleanup = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    newCancelBtn.remove();
                    newConfirmBtn.style.backgroundColor = '';
                    newConfirmBtn.textContent = '確定';
                    // 移除事件監聽器
                    document.removeEventListener('keydown', handleKeyPress);
                };
                
                // 處理鍵盤事件
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        cleanup();
                        resolve(true);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cleanup();
                        resolve(false);
                    }
                };
                
                // 添加事件監聽器
                document.addEventListener('keydown', handleKeyPress);
                
                newConfirmBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                newCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                alertOverlay.onclick = (e) => {
                    if (e.target === alertOverlay) {
                        cleanup();
                        resolve(false);
                    }
                };
            });
            
            if (confirmDelete) {
                await deleteMember();
            }
        }

        // 刪除會員
        async function deleteMember() {
            if (!currentDeletingMember) return;

            try {
                showLoading();
                // 先確認是否為管理員
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('權限不足');
                }

                console.log('開始刪除會員:', currentDeletingMember);

                // 搜尋會員
                const querySnapshot = await db.collectionGroup('data')
                    .where('barcode', '==', currentDeletingMember.barcode)
                    .where('role', '==', 'customer')
                    .limit(1)
                    .get();

                if (querySnapshot.empty) {
                    throw new Error('找不到此會員');
                }

                const userProfile = querySnapshot.docs[0];
                const userId = userProfile.ref.parent.parent.id;

                // 刪除會員所有資料
                const batch = db.batch();

                // 刪除 profile 文檔
                batch.delete(userProfile.ref);

                // 刪除訪問記錄
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .get();

                visitsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 執行批次刪除
                await batch.commit();

                await showCustomAlert(`會員 ${currentDeletingMember.name || currentDeletingMember.barcode} 已成功刪除`);
                
                // 隱藏會員詳情
                document.getElementById('customerInfo').classList.add('hidden');
                currentDeletingMember = null;
            } catch (error) {
                console.error('刪除會員時發生錯誤:', error);
                await showCustomAlert('刪除會員失敗：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 增加到訪次數
        async function addVisit() {
            try {
                showLoading();
                console.log('開始增加到訪紀錄');
                console.log('當前搜尋到的會員:', window.currentSearchedMember);

                if (!window.currentSearchedMember) {
                    console.log('未找到當前搜尋的會員資料');
                    hideLoading();
                    await showCustomAlert('請先搜尋會員');
                    return;
                }

                // 先確認是否為管理員
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    hideLoading();
                    throw new Error('請先登入');
                }
                
                console.log('當前用戶:', currentUser.uid);
                
                if (currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    hideLoading();
                    throw new Error('權限不足');
                }

                const { userId, barcode } = window.currentSearchedMember;
                console.log('準備增加到訪紀錄:', { userId, barcode });
            
                // 直接增加到訪紀錄，不需要檢查今日是否已到訪
                const visitRef = await db.collection('users').doc(userId)
                    .collection('visits')
                    .add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        scannedBy: currentUser.uid
                    });

                console.log('到訪紀錄已新增:', visitRef.id);
                hideLoading();
                await showCustomAlert('已成功增加到訪紀錄！');
                
                // 重新載入會員詳情
                console.log('重新載入會員詳情');
                showLoading();
                await viewMemberDetails(userId);
                hideLoading();
            } catch (error) {
                console.error('增加到訪紀錄時發生錯誤:', error);
                hideLoading();
                await showCustomAlert('增加到訪紀錄失敗：' + error.message);
            }
        }

        // 添加顯示和隱藏載入動畫的函數
        function showLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // 新增會員功能
        async function addNewMember() {
            try {
                showLoading();
                
                // 檢查是否為管理員
                const currentUser = auth.currentUser;
                if (!currentUser || currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('權限不足');
                }

                // 獲取表單數據
                const email = document.getElementById('newMemberEmail').value.trim();
                const name = document.getElementById('newMemberName').value.trim();
                const idNumber = document.getElementById('newMemberIdNumber').value.trim();
                const birthDate = document.getElementById('newMemberBirthDate').value;
                const phone = document.getElementById('newMemberPhone').value.trim();
                const nationality = document.getElementById('newMemberNationality').value.trim();

                // 驗證必填欄位（移除 email 的必填檢查）
                if (!name || !idNumber || !birthDate || !phone || !nationality) {
                    throw new Error('請填寫所有必填欄位（電子郵件為選填）');
                }

                // 如果有填寫 email，則檢查格式
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('請輸入有效的電子郵件地址');
                }

                // 生成會員條碼
                const timestamp = Date.now();
                const barcode = `MEM${timestamp}`;

                // 檢查是否已存在相同的證件號碼
                const existingMemberQuery = await db.collectionGroup('data')
                    .where('idNumber', '==', idNumber)
                    .where('role', '==', 'customer')
                    .get();

                if (!existingMemberQuery.empty) {
                    throw new Error('此證件號碼已被註冊');
                }

                // 創建新的會員文檔
                const newMemberRef = db.collection('users').doc();
                await newMemberRef.collection('data').doc('profile').set({
                    role: 'customer',
                    email: email || '', // 如果沒有 email 則設為空字串
                    barcode: barcode,
                    name: name,
                    idNumber: idNumber,
                    birthDate: birthDate,
                    phone: phone,
                    nationality: nationality,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isInfoComplete: true
                });

                // 清空表單
                document.getElementById('newMemberEmail').value = '';
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberIdNumber').value = '';
                document.getElementById('newMemberBirthDate').value = '';
                document.getElementById('newMemberPhone').value = '';
                document.getElementById('newMemberNationality').value = '';

                await showCustomAlert(`會員新增成功！\n會員條碼：${barcode}`);
            } catch (error) {
                console.error('新增會員時發生錯誤:', error);
                await showCustomAlert('新增會員失敗：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 新增會員表單收合功能
        function toggleNewMemberForm() {
            const content = document.getElementById('newMemberForm');
            const icon = document.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // 會員清單相關變數
        let currentPage = 1;
        const membersPerPage = 10;
        let totalMembers = 0;
        let allMembers = [];

        // 切換會員清單顯示
        function toggleMemberList() {
            const content = document.getElementById('memberListContent');
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                loadMemberList();
            }
        }

        // 載入會員清單
        async function loadMemberList() {
            try {
                showLoading();
                
                // 檢查管理員權限
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('權限不足');
                }

                // 獲取所有會員資料
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                allMembers = await Promise.all(querySnapshot.docs.map(async doc => {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // 獲取到訪次數
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    return {
                        ...userData,
                        userId: userId,
                        visitCount: visitsSnapshot.size
                    };
                }));

                totalMembers = allMembers.length;
                displayMemberList();
                updatePagination();
            } catch (error) {
                console.error('載入會員清單時發生錯誤:', error);
                await showCustomAlert('載入會員清單失敗：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 顯示會員清單
        function displayMemberList() {
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            const start = (currentPage - 1) * membersPerPage;
            const end = start + membersPerPage;
            const pageMembers = allMembers.slice(start, end);
            
            pageMembers.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${member.barcode || ''}</td>
                    <td>${member.name || ''}</td>
                    <td>${member.phone || ''}</td>
                    <td>${member.visitCount || 0}</td>
                    <td class="action-column">
                        <button class="view-btn" onclick="viewMemberDetails('${member.userId}')">查看</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 更新分頁按鈕
        function updatePagination() {
            const pagination = document.getElementById('memberListPagination');
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            
            let paginationHTML = '';
            
            // 上一頁按鈕
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    上一頁
                </button>
            `;
            
            // 頁碼按鈕
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" 
                            class="${currentPage === i ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // 下一頁按鈕
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    下一頁
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // 切換頁面
        function changePage(page) {
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayMemberList();
            updatePagination();
        }

        // 處理搜尋欄位的按鍵事件
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchMember();
            }
        }

        // 音效初始化
        const reminderSound = document.getElementById('reminderSound');
        const exportSound = document.getElementById('exportSound');

        // 音效播放函數
        function playReminderSound() {
            try {
                reminderSound.currentTime = 0;
                reminderSound.play().catch(error => {
                    console.log('提醒音效播放失敗:', error);
                });
            } catch (error) {
                console.log('提醒音效播放出錯:', error);
            }
        }

        function playExportSound() {
            try {
                exportSound.currentTime = 0;
                exportSound.play().catch(error => {
                    console.log('匯出音效播放失敗:', error);
                });
            } catch (error) {
                console.log('匯出音效播放出錯:', error);
            }
        }

        // 在顯示提醒時播放音效
        function showReminderDialog() {
            playReminderSound();
            // ... 其他提醒對話框顯示邏輯 ...
        }

        // 在匯出完成時播放音效
        function onExportComplete() {
            playExportSound();
            // ... 其他匯出完成邏輯 ...
        }

        // 匯出會員資料功能
        async function exportMemberData() {
            try {
                showLoading();
                
                // 播放匯出音效
                playExportSound();
                
                // 檢查管理員權限
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    hideLoading();
                    throw new Error('權限不足');
                }

                // 獲取所有會員資料
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                // 準備 TSV 資料
                let tsvContent = '會員條碼\t姓名\t電話\t電子郵件\t證件號碼\t出生年月日\t國籍\t到訪次數\n';

                // 處理每個會員的資料
                for (const doc of querySnapshot.docs) {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // 獲取到訪次數
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    // 將資料加入 TSV
                    tsvContent += `${userData.barcode || ''}\t${userData.name || ''}\t${userData.phone || ''}\t${userData.email || ''}\t${userData.idNumber || ''}\t${userData.birthDate || ''}\t${userData.nationality || ''}\t${visitsSnapshot.size}\n`;
                }

                // 創建 Blob 並下載
                const blob = new Blob(['\ufeff' + tsvContent], { type: 'text/tab-separated-values;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `會員資料_${new Date().toLocaleDateString()}.tsv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                hideLoading();
                await showCustomAlert('備份完成！');
            } catch (error) {
                console.error('匯出會員資料時發生錯誤:', error);
                hideLoading();
                await showCustomAlert('匯出失敗：' + error.message);
            }
        }

        // 顯示排程對話框
        function showScheduleDialog() {
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            // 設置對話框內容
            messageElement.innerHTML = `
                <h3>設定備份時間</h3>
                <p>請選擇每日提醒備份時間：</p>
                <input type="time" id="reminderTime" value="${localStorage.getItem('reminderTime') || '09:00'}">
            `;
            
            // 修改確認按鈕
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = '確認';
            
            // 顯示對話框
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // 綁定確認按鈕事件
            confirmBtn.onclick = async () => {
                const time = document.getElementById('reminderTime').value;
                if (!time) {
                    await showCustomAlert('請選擇提醒備份時間');
                    return;
                }
                
                // 儲存設定
                localStorage.setItem('reminderTime', time);
                setupReminder(time);
                
                // 關閉對話框
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                
                await showCustomAlert(`提醒時間已設定為 ${time}`);
            };
        }

        // 設置提醒
        function setupReminder(time) {
            // 清除現有的提醒
            if (window.reminderTimeout) {
                clearTimeout(window.reminderTimeout);
            }
            
            // 計算下次提醒時間
            const [hours, minutes] = time.split(':').map(Number);
            const now = new Date();
            let next = new Date(now);
            next.setHours(hours, minutes, 0, 0);
            
            if (next <= now) {
                next.setDate(next.getDate() + 1);
            }
            
            // 設置提醒
            const delay = next.getTime() - now.getTime();
            window.reminderTimeout = setTimeout(() => {
                showReminderNotification();
                setupReminder(time); // 設置下一次提醒
            }, delay);
            
            console.log(`下次提醒時間：${next.toLocaleString()}`);
        }

        // 顯示提醒通知
        async function showReminderNotification() {
            playReminderSound();
            
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            messageElement.innerHTML = `
                <h3>備份提醒</h3>
                <p>現在是否要備份資料？</p>
            `;
            
            // 修改按鈕
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = '立即備份';
            
            // 添加延後按鈕
            const postponeBtn = document.createElement('button');
            postponeBtn.textContent = '稍後提醒';
            postponeBtn.className = 'confirm-btn';
            postponeBtn.style.marginLeft = '10px';
            postponeBtn.style.backgroundColor = '#6c757d';
            confirmBtn.parentNode.appendChild(postponeBtn);
            
            // 顯示對話框
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // 綁定按鈕事件
            confirmBtn.onclick = async () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                await exportMemberData();
            };
            
            postponeBtn.onclick = () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                // 5 分鐘後再次提醒
                setTimeout(showReminderNotification, 5 * 60 * 1000);
            };
        }

        // 在登入後恢復提醒設定
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const isStaff = await checkIfStaff(user.uid);
                if (isStaff) {
                    const savedTime = localStorage.getItem('reminderTime');
                    if (savedTime) {
                        setupReminder(savedTime);
                    }
                }
            }
        });

        // 報表分析相關函數
        let memberGrowthChart = null;
        let visitFrequencyChart = null;
        let memberActivityChart = null;

        function toggleReportSection() {
            const content = document.getElementById('reportContent');
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                updateReports();
            }
        }

        async function updateReports() {
            try {
                const loading = document.querySelector('.report-loading');
                loading.style.display = 'flex';
                
                const days = parseInt(document.getElementById('reportDateRange').value);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);

                // 獲取會員資料
                const membersSnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                // 獲取訪問記錄
                const visitsSnapshot = await db.collectionGroup('visits')
                    .where('timestamp', '>=', startDate)
                    .where('timestamp', '<=', endDate)
                    .get();

                // 處理資料
                const memberData = processMemberData(membersSnapshot, startDate);
                const visitData = processVisitData(visitsSnapshot, startDate, days);
                const activityData = processActivityData(visitsSnapshot, membersSnapshot);

                // 更新圖表
                updateMemberGrowthChart(memberData);
                updateVisitFrequencyChart(visitData);
                updateMemberActivityChart(activityData);
            } catch (error) {
                console.error('更新報表時發生錯誤:', error);
                await showCustomAlert('更新報表失敗：' + error.message);
            } finally {
                const loading = document.querySelector('.report-loading');
                loading.style.display = 'none';
            }
        }

        function processMemberData(snapshot, startDate) {
            const data = {
                labels: [],
                counts: []
            };

            // 從今天開始往回推
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);  // 設定為今天的最後一刻
            
            // 初始化每天的資料
            const dayData = {};
            const days = parseInt(document.getElementById('reportDateRange').value);  // 使用選擇的日期範圍
            for (let i = days - 1; i >= 0; i--) {
                const currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() - i);
                const dayLabel = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                dayData[dayLabel] = 0;
            }

            // 統計每天的新增會員數
            snapshot.docs.forEach(doc => {
                const memberData = doc.data();
                const joinDate = memberData.createdAt?.toDate();
                if (joinDate && joinDate >= startDate && joinDate <= endDate) {
                    const dayLabel = `${joinDate.getMonth() + 1}/${joinDate.getDate()}`;
                    if (dayData.hasOwnProperty(dayLabel)) {
                        dayData[dayLabel]++;
                    }
                }
            });

            // 轉換為圖表資料，保持時間順序
            Object.keys(dayData).forEach(dayLabel => {
                data.labels.push(dayLabel);
                data.counts.push(dayData[dayLabel]);
            });

            return data;
        }

        function processVisitData(snapshot, startDate, days) {
            const data = {
                labels: [],
                counts: []
            };

            // 從今天開始往回推
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);  // 設定為今天的最後一刻
            
            // 初始化每天的資料
            const dayData = {};
            for (let i = days - 1; i >= 0; i--) {
                const currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() - i);
                const dayLabel = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                dayData[dayLabel] = 0;
            }

            // 統計每天的訪問次數
            snapshot.docs.forEach(doc => {
                const visitDate = doc.data().timestamp.toDate();
                if (visitDate >= startDate && visitDate <= endDate) {
                    const dayLabel = `${visitDate.getMonth() + 1}/${visitDate.getDate()}`;
                    if (dayData.hasOwnProperty(dayLabel)) {
                        dayData[dayLabel]++;
                    }
                }
            });

            // 轉換為圖表資料，保持時間順序
            Object.keys(dayData).forEach(dayLabel => {
                data.labels.push(dayLabel);
                data.counts.push(dayData[dayLabel]);
            });

            return data;
        }

        function processActivityData(visitsSnapshot, membersSnapshot) {
            const memberVisits = {};
            visitsSnapshot.docs.forEach(doc => {
                const memberId = doc.ref.parent.parent.id;
                memberVisits[memberId] = (memberVisits[memberId] || 0) + 1;
            });

            const activityLevels = {
                '高活躍度': 0,
                '中活躍度': 0,
                '低活躍度': 0
            };

            Object.values(memberVisits).forEach(visits => {
                if (visits >= 5) {
                    activityLevels['高活躍度']++;
                } else if (visits >= 2) {
                    activityLevels['中活躍度']++;
                } else {
                    activityLevels['低活躍度']++;
                }
            });

            return {
                labels: Object.keys(activityLevels),
                counts: Object.values(activityLevels)
            };
        }

        function updateMemberGrowthChart(data) {
            const ctx = document.getElementById('memberGrowthChart').getContext('2d');
            
            if (memberGrowthChart) {
                memberGrowthChart.destroy();
            }

            memberGrowthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '每週新增會員數',
                        data: data.counts,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '會員週增長趨勢',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `新增會員數：${context.raw} 人`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '新增會員數'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateVisitFrequencyChart(data) {
            const ctx = document.getElementById('visitFrequencyChart').getContext('2d');
            
            if (visitFrequencyChart) {
                visitFrequencyChart.destroy();
            }

            visitFrequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '每日到訪次數',
                        data: data.counts,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '每日到訪頻率分析',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `到訪次數：${context.raw} 次`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '到訪次數'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateMemberActivityChart(data) {
            const ctx = document.getElementById('memberActivityChart').getContext('2d');
            
            if (memberActivityChart) {
                memberActivityChart.destroy();
            }

            memberActivityChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.counts,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(255, 99, 132, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: '會員活躍度分布'
                        }
                    }
                }
            });
        }

        // 顯示報表分析對話框
        async function showReportDialog() {
            try {
                showLoading();
                const dialog = document.querySelector('.report-dialog');
                dialog.style.display = 'block';
                await updateReports(); // 自動更新報表
            } catch (error) {
                console.error('顯示報表分析時發生錯誤:', error);
                await showCustomAlert('顯示報表分析失敗：' + error.message);
            } finally {
                hideLoading();
            }
        }

        // 隱藏報表分析對話框
        function hideReportDialog() {
            const dialog = document.querySelector('.report-dialog');
            dialog.style.display = 'none';
        }

        // 導入會員資料相關函數
        function importMemberData() {
            document.getElementById('importDialog').classList.remove('hidden');
        }

        function hideImportDialog() {
            document.getElementById('importDialog').classList.add('hidden');
            document.getElementById('importFile').value = '';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importProgressBar').style.width = '0%';
            document.getElementById('importStatus').textContent = '';
        }

        async function startImport() {
            try {
                showLoading();
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    await showCustomAlert('請選擇要導入的檔案');
                    return;
                }

                const updateExisting = document.getElementById('updateExisting').checked;
                const createNew = document.getElementById('createNew').checked;

                if (!updateExisting && !createNew) {
                    await showCustomAlert('請至少選擇一個導入選項');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        
                        // 檢查標題行
                        const headers = lines[0].split('\t');
                        const requiredHeaders = ['會員條碼', '姓名', '電話', '電子郵件', '證件號碼', '出生年月日', '國籍', '到訪次數'];
                        const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                        
                        if (missingHeaders.length > 0) {
                            await showCustomAlert(`檔案格式錯誤：缺少必要的欄位 - ${missingHeaders.join(', ')}`);
                            return;
                        }

                        // 顯示進度條
                        document.getElementById('importProgress').style.display = 'block';
                        const progressBar = document.getElementById('importProgressBar');
                        const statusText = document.getElementById('importStatus');

                        // 處理每一行數據
                        let successCount = 0;
                        let errorCount = 0;
                        let totalCount = lines.length - 1; // 減去標題行

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            const values = lines[i].split('\t');
                            const memberData = {
                                barcode: values[0],
                                name: values[1],
                                phone: values[2],
                                email: values[3],
                                idNumber: values[4],
                                birthDate: values[5],
                                nationality: values[6],
                                visitCount: parseInt(values[7]) || 0
                            };

                            try {
                                // 檢查是否已存在相同證件號碼的會員
                                const existingQuery = await db.collectionGroup('data')
                                    .where('idNumber', '==', memberData.idNumber)
                                    .where('role', '==', 'customer')
                                    .get();

                                if (!existingQuery.empty && updateExisting) {
                                    // 更新現有會員
                                    const existingDoc = existingQuery.docs[0];
                                    const userId = existingDoc.ref.parent.parent.id;
                                    
                                    // 更新會員資料
                                    await existingDoc.ref.update({
                                        name: memberData.name,
                                        phone: memberData.phone,
                                        email: memberData.email,
                                        birthDate: memberData.birthDate,
                                        nationality: memberData.nationality,
                                        isInfoComplete: true
                                    });

                                    // 更新到訪次數
                                    const currentVisits = await db.collection('users')
                                        .doc(userId)
                                        .collection('visits')
                                        .get();

                                    const visitsToAdd = memberData.visitCount - currentVisits.size;
                                    if (visitsToAdd > 0) {
                                        const batch = db.batch();
                                        for (let j = 0; j < visitsToAdd; j++) {
                                            const visitRef = db.collection('users')
                                                .doc(userId)
                                                .collection('visits')
                                                .doc();
                                            batch.set(visitRef, {
                                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                                scannedBy: auth.currentUser.uid
                                            });
                                        }
                                        await batch.commit();
                                    }
                                } else if (createNew) {
                                    // 創建新會員
                                    const newMemberRef = db.collection('users').doc();
                                    await newMemberRef.collection('data').doc('profile').set({
                                        role: 'customer',
                                        ...memberData,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        isInfoComplete: true
                                    });

                                    // 添加訪問記錄
                                    if (memberData.visitCount > 0) {
                                        const batch = db.batch();
                                        for (let j = 0; j < memberData.visitCount; j++) {
                                            const visitRef = db.collection('users')
                                                .doc(newMemberRef.id)
                                                .collection('visits')
                                                .doc();
                                            batch.set(visitRef, {
                                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                                scannedBy: auth.currentUser.uid
                                            });
                                        }
                                        await batch.commit();
                                    }
                                }

                                successCount++;
                            } catch (error) {
                                console.error(`處理第 ${i} 行數據時發生錯誤:`, error);
                                errorCount++;
                            }

                            // 更新進度條
                            const progress = (i / totalCount) * 100;
                            progressBar.style.width = `${progress}%`;
                            statusText.textContent = `已處理 ${i}/${totalCount} 筆資料 (成功: ${successCount}, 失敗: ${errorCount})`;
                        }

                        hideLoading();
                        await showCustomAlert(`導入完成！\n成功: ${successCount} 筆\n失敗: ${errorCount} 筆`);
                        hideImportDialog();
                    } catch (error) {
                        console.error('導入數據時發生錯誤:', error);
                        hideLoading();
                        await showCustomAlert('導入失敗：' + error.message);
                    }
                };

                reader.readAsText(file);
            } catch (error) {
                console.error('開始導入時發生錯誤:', error);
                hideLoading();
                await showCustomAlert('導入失敗：' + error.message);
            }
        }
    </script>
</body>
</html>