<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLç’½æ„›</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- HTML5 QRCode -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden {
            display: none !important;
        }
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f5f5f5;
        }

        /* å¾Œå°ç®¡ç†ä»‹é¢æ¨£å¼ */
        #staffSection {
            max-width: 100%;
            margin: 0;
            padding: 20px;
            background-color: #fff;
        }
        
        #staffSection .search-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 100%;
        }

        #staffSection .search-section h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            text-align: center;
        }

        #staffSection .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #staffSection .search-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #staffSection .search-form label {
            font-size: 16px;
            color: #333;
        }

        #staffSection .search-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        #staffSection .search-form .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #staffSection .search-form button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background-color: #4285f4;
            color: white;
        }

        #staffSection .search-form button:hover {
            background-color: #357abd;
        }

        #staffSection .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #staffSection .info-table th,
        #staffSection .info-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #staffSection .info-table th {
            background-color: #f5f5f5;
            font-weight: normal;
            width: 120px;
        }

        #staffSection .action-btn {
            padding: 5px 15px;
            margin: 5px;
            border: none;
            cursor: pointer;
        }

        #staffSection #visitHistory {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        #staffSection #visitHistory p {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        #staffLogoutBtn {
            margin-top: 20px;
            padding: 5px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            background-color: #dc3545 !important;
            color: white;
        }

        /* æœƒå“¡ä»‹é¢æ¨£å¼ */
        #customerSection {
            max-width: 100%;
            padding: 10px;
        }

        #customerSection .form-group {
            margin: 20px 0;
        }

        #customerSection .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #customerSection .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }

        #customerSection button {
            width: 100%;
            padding: 15px 25px;
            font-size: 16px;
            margin: 10px 0;
        }

        /* é€šç”¨æ¨£å¼ */
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #357abd;
        }

        .info-table {
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-table th, .info-table td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
        }

        /* ç™»å…¥ä»‹é¢æ¨£å¼ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 16px;
        }

        .google-login-btn img {
            width: 24px;
            margin-right: 10px;
        }

        /* æ¢ç¢¼é¡¯ç¤ºæ¨£å¼ */
        .barcode-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .barcode-item {
            margin: 20px 0;
            text-align: center;
        }

        .barcode-item svg {
            max-width: 100%;
            height: auto;
        }

        /* åˆªé™¤ç¢ºèªå°è©±æ¡†æ¨£å¼ */
        .modal {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆåƒ…é‡å°æœƒå“¡ä»‹é¢ï¼‰ */
        @media (max-width: 480px) {
            #customerSection {
                padding: 10px;
            }

            #customerSection .form-group label {
                font-size: 14px;
            }

            #customerSection .form-group input {
                font-size: 16px;
                padding: 10px;
            }

            #customerSection button {
                padding: 12px 20px;
                font-size: 16px;
            }

            .login-container {
                padding: 20px;
            }

            .login-container h2 {
                font-size: 20px;
            }
        }

        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #fff;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-text {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .loading-text img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            max-width: 100vw;
            max-height: 100vh;
        }

        /* è‡ªå®šç¾©æç¤ºæ¡†æ¨£å¼ */
        .custom-alert {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            text-align: center;
            min-width: 300px;
            border: 1px solid #e0e0e0;
        }

        .custom-alert .message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .custom-alert .confirm-btn {
            padding: 10px 30px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-alert .confirm-btn:hover {
            background-color: #357abd;
        }

        .alert-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2999;
        }

        /* æ–°å¢æœƒå“¡æ”¶åˆæŒ‰éˆ•æ¨£å¼ */
        .toggle-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 100%;
        }

        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .toggle-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .toggle-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .toggle-content.expanded {
            max-height: 1000px;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        /* æœƒå“¡æ¸…å–®è¡¨æ ¼æ¨£å¼ */
        .member-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
        }

        .member-table th,
        .member-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .member-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .member-table tr:hover {
            background-color: #f5f5f5;
        }

        .member-table .action-column {
            width: 100px;
            text-align: center;
        }

        .view-btn {
            padding: 5px 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-btn:hover {
            background-color: #357abd;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 5px 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            color: #333;
        }

        .pagination button:hover {
            background-color: #f5f5f5;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination button.active {
            background-color: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        /* å ±è¡¨åˆ†æç›¸é—œæ¨£å¼ */
        .report-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: white;
            z-index: 1000;
        }

        .report-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1001;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .report-loading img {
            width: 100%;
            height: 100%;
            object-fit: fill;
        }

        .report-content {
            width: 100%;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #ccc;
            gap: 20px;
        }

        .report-header h2 {
            margin: 0;
            font-size: 24px;
            order: 1;
        }

        .report-close-btn {
            padding: 8px 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            order: 2;
            margin-right: 20px;
        }

        .report-close-btn:hover {
            background-color: #d32f2f;
        }

        .report-filters {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .report-filters select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .report-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            flex: 1;
        }

        .chart-container {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- è‡ªå®šç¾©æç¤ºæ¡† -->
    <div class="alert-overlay"></div>
    <div class="custom-alert">
        <div class="message"></div>
        <button class="confirm-btn">ç¢ºå®š</button>
    </div>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading-overlay">
        <div class="loading-text">
            <img src="SystemProcessing.bmp" alt="ç³»çµ±è™•ç†ä¸­">
        </div>
    </div>

    <!-- ç™»å…¥å€åŸŸ -->
    <div id="loginSection" class="login-overlay">
        <div class="login-container">
            <h2>SLç’½æ„›æ—…åº—<h2>
            <div id="adminLoginSection" class="hidden">
                <div class="form-group">
                    <label for="email">é›»å­éƒµä»¶ï¼š</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç¢¼ï¼š</label>
                    <input type="password" id="password" required>
                </div>
                <button id="emailLogin">ç™»å…¥ï¼ˆè¼¸å…¥å®Œè«‹æŒ‰é€™å€‹ï¼‰</button>
            </div>
            <div id="memberLoginSection">
                <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥ä½¿ç”¨æœƒå“¡åŠŸèƒ½</p>
                <button id="googleLogin" class="google-login-btn">
                    <img src="https://www.google.com/favicon.ico" alt="Google" style="width: 20px; margin-right: 10px;">
                    ä½¿ç”¨ Google ç™»å…¥
                </button>
            </div>
            <div class="admin-login-hint">
                <button id="showAdminLogin" class="text-button">ç®¡ç†å“¡ç™»å…¥</button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡è³‡æ–™å¡«å¯«å€åŸŸ -->
    <div id="customerSection" class="hidden">
        <h2>æœƒå“¡è³‡æ–™ï¼ˆcustomerï¼‰</h2>
        <div class="info-message">è«‹å…ˆå®Œæ•´å¡«å¯«æœƒå“¡è³‡æ–™æ‰èƒ½å–å¾—æœƒå“¡æ¢ç¢¼ Key your customer data to get your barcode</div>
        <form id="memberInfoForm">
            <div class="form-group">
                <label>é›»å­éƒµä»¶ï¼ˆemailï¼‰ï¼š</label>
                <span id="memberEmailDisplay"></span>
            </div>
            <div class="form-group">
                <label for="name">å§“åï¼ˆnameï¼‰</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="idNumber">è­‰ä»¶è™Ÿç¢¼ï¼ˆidNumberï¼‰</label>
                <input type="text" id="idNumber" required>
            </div>
            <div class="form-group">
                <label for="birthDate">å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆbirthDateï¼‰</label>
                <input type="date" id="birthDate" required>
            </div>
            <div class="form-group">
                <label for="phone">é›»è©±è™Ÿç¢¼ï¼ˆphoneï¼‰</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label for="nationality">åœ‹ç±ï¼ˆnationalityï¼‰</label>
                <input type="text" id="nationality" required>
            </div>
            <button type="submit" class="submit-btn">å„²å­˜è³‡æ–™ï¼ˆsaveï¼‰</button>
        </form>
        <div id="barcodeDisplay" class="hidden">
            <h3>æ‚¨çš„æœƒå“¡æ¢ç¢¼ï¼ˆbarcodeï¼‰</h3>
            <p class="barcode-notice">è«‹å¦¥å–„ä¿å­˜æ­¤æ¢ç¢¼ï¼Œæ¯æ¬¡åˆ°è¨ªæ™‚è«‹å‡ºç¤ºï¼ˆshowï¼‰</p>
            <div class="barcode-container">
                <div class="barcode-number">æ¢ç¢¼ç·¨è™Ÿï¼š<span id="memberBarcodeDisplay"></span></div>
                <div id="barcodeContainer"></div>
            </div>
        </div>
        <button id="logoutBtn">ç™»å‡ºï¼ˆlogoutï¼‰</button>
    </div>

    <!-- åº—å“¡ä»‹é¢ -->
    <div id="staffSection" class="hidden">
        <h2>å¾Œå°</h2>
        
        <!-- åŠŸèƒ½æŒ‰éˆ•å€åŸŸ -->
        <div class="toggle-section">
            <div class="button-group" style="margin: 15px 0; display: flex; gap: 15px;">
                <button onclick="exportMemberData()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #4CAF50; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">ğŸ“Š</span>
                    å‚™ä»½åŒ¯å‡º
                </button>
                <button onclick="importMemberData()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #FF9800; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">ğŸ“¥</span>
                    å‚™ä»½å°å…¥
                </button>
                <button onclick="showScheduleDialog()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #2196F3; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">â°</span>
                    è¨­å®šå‚™ä»½æé†’æ™‚é–“
                </button>
                <button onclick="showReportDialog()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #9C27B0; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">ğŸ“ˆ</span>
                    æƒ…å ±åˆ†æ
                </button>
            </div>
        </div>
        
        <!-- æœƒå“¡æ¸…å–®å€åŸŸ -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleMemberList()">
                <h2>æœƒå“¡æ¸…å–®</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="toggle-content" id="memberListContent">
                <div class="member-list-container">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th>æœƒå“¡æ¢ç¢¼</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>åˆ°è¨ªæ¬¡æ•¸</th>
                                <th class="action-column">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody">
                            <!-- æœƒå“¡è³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                    <div class="pagination" id="memberListPagination">
                        <!-- åˆ†é æŒ‰éˆ•å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢æœƒå“¡å€åŸŸ -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleNewMemberForm()">
                <h2>æ–°å¢æœƒå“¡</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="toggle-content" id="newMemberForm">
                <div class="search-form">
                    <div class="form-group">
                        <label for="newMemberEmail">é›»å­éƒµä»¶ï¼š</label>
                        <input type="email" id="newMemberEmail" placeholder="è«‹è¼¸å…¥æœƒå“¡é›»å­éƒµä»¶">
                    </div>
                    <div class="form-group">
                        <label for="newMemberName">å§“åï¼š</label>
                        <input type="text" id="newMemberName" placeholder="è«‹è¼¸å…¥æœƒå“¡å§“å">
                    </div>
                    <div class="form-group">
                        <label for="newMemberIdNumber">è­‰ä»¶è™Ÿç¢¼ï¼š</label>
                        <input type="text" id="newMemberIdNumber" placeholder="è«‹è¼¸å…¥è­‰ä»¶è™Ÿç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberBirthDate">å‡ºç”Ÿå¹´æœˆæ—¥ï¼š</label>
                        <input type="date" id="newMemberBirthDate">
                    </div>
                    <div class="form-group">
                        <label for="newMemberPhone">é›»è©±è™Ÿç¢¼ï¼š</label>
                        <input type="tel" id="newMemberPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberNationality">åœ‹ç±ï¼š</label>
                        <input type="text" id="newMemberNationality" placeholder="è«‹è¼¸å…¥åœ‹ç±">
                    </div>
                    <div class="button-group">
                        <button onclick="addNewMember()">æ–°å¢æœƒå“¡</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœå°‹å€åŸŸ -->
        <div class="search-section">
            <h2>æœƒå“¡æœå°‹</h2>
            <div class="search-form">
                <div class="form-group">
                    <label for="searchBarcode">æœƒå“¡æ¢ç¢¼ï¼š</label>
                    <input type="text" id="searchBarcode" placeholder="è«‹è¼¸å…¥æœƒå“¡æ¢ç¢¼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="form-group">
                    <label for="searchIdNumber">è­‰ä»¶è™Ÿç¢¼ï¼š</label>
                    <input type="text" id="searchIdNumber" placeholder="è«‹è¼¸å…¥è­‰ä»¶è™Ÿç¢¼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="button-group">
                    <button onclick="searchMember()">æœå°‹</button>
                    <button id="addVisitBtn" disabled onclick="addVisit()">å¢åŠ åˆ°è¨ªæ¬¡æ•¸</button>
                </div>
            </div>
        </div>

        <!-- æœƒå“¡è©³ç´°è³‡æ–™ -->
        <div id="customerInfo" class="hidden">
            <h3>æœƒå“¡è©³ç´°è³‡æ–™</h3>
            <table class="info-table">
                <tr><th>æœƒå“¡æ¢ç¢¼</th><td id="customerBarcode"></td></tr>
                <tr><th>å§“å</th><td id="customerName"></td></tr>
                <tr><th>é›»è©±</th><td id="customerPhone"></td></tr>
                <tr><th>é›»å­éƒµä»¶</th><td id="customerEmail"></td></tr>
                <tr><th>è­‰ä»¶è™Ÿç¢¼</th><td id="customerIdNumber"></td></tr>
                <tr><th>å‡ºç”Ÿå¹´æœˆæ—¥</th><td id="customerBirthDate"></td></tr>
                <tr><th>åœ‹ç±</th><td id="customerNationality"></td></tr>
                <tr><th>åˆ°è¨ªæ¬¡æ•¸</th><td id="visitCount"></td></tr>
            </table>
            <div style="margin: 20px 0;">
                <button class="action-btn delete-btn" onclick="showDeleteConfirm()">åˆªé™¤æœƒå“¡</button>
            </div>
            <h4>åˆ°è¨ªè¨˜éŒ„</h4>
            <div id="visitHistory"></div>
        </div>

        <button id="staffLogoutBtn">ç™»å‡º</button>
    </div>

    <!-- å ±è¡¨åˆ†æå°è©±æ¡† -->
    <div class="report-dialog">
        <div class="report-loading">
            <img src="SystemProcessing.bmp" alt="è¼‰å…¥ä¸­">
        </div>
        <div class="report-content">
            <div class="report-header">
                <h2>æƒ…å ±åˆ†æ</h2>
                <button class="report-close-btn" onclick="hideReportDialog()">é—œé–‰</button>
            </div>
            <div class="report-filters">
                <div class="form-group">
                    <label for="reportDateRange">é¸æ“‡æ—¥æœŸç¯„åœï¼š</label>
                    <select id="reportDateRange" onchange="updateReports()">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="14">æœ€è¿‘14å¤©</option>
                        <option value="30">æœ€è¿‘30å¤©</option>
                        <option value="90">æœ€è¿‘90å¤©</option>
                        <option value="180">æœ€è¿‘180å¤©</option>
                        <option value="365">æœ€è¿‘1å¹´</option>
                        <option value="730">æœ€è¿‘2å¹´</option>
                    </select>
                </div>
            </div>
            <div class="report-charts">
                <div class="chart-container">
                    <h3>æœƒå“¡æˆé•·è¶¨å‹¢</h3>
                    <canvas id="memberGrowthChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>åˆ°è¨ªé »ç‡åˆ†æ</h3>
                    <canvas id="visitFrequencyChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>æœƒå“¡æ´»èºåº¦åˆ†æ</h3>
                    <canvas id="memberActivityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ éŸ³æ•ˆå…ƒç´  -->
    <audio id="reminderSound" preload="auto">
        <source src="SystemMessage_warning1.wav" type="audio/wav">
    </audio>
    <audio id="exportSound" preload="auto">
        <source src="SystemMessage_warning2.wav" type="audio/wav">
    </audio>

    <!-- å°å…¥æ•¸æ“šå°è©±æ¡† -->
    <div id="importDialog" class="hidden" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; z-index: 1000;">
        <div class="report-content">
            <div class="report-header">
                <h2>å°å…¥å‚™ä»½</h2>
                <button class="report-close-btn" onclick="hideImportDialog()">é—œé–‰</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label for="importFile">é¸æ“‡ TSV æª”æ¡ˆï¼š</label>
                    <input type="file" id="importFile" accept=".tsv" style="width: 100%; padding: 10px; margin: 10px 0;">
                </div>
                <div class="form-group">
                    <label>å°å…¥é¸é …ï¼š</label>
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="updateExisting" checked>
                        <label for="updateExisting">æ›´æ–°å·²å­˜åœ¨çš„æœƒå“¡è³‡æ–™</label>
                    </div>
                    <div style="margin: 10px 0;">
                        <input type="checkbox" id="createNew" checked>
                        <label for="createNew">å‰µå»ºæ–°æœƒå“¡</label>
                    </div>
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button onclick="startImport()" style="width: 100%; padding: 15px; font-size: 16px;">é–‹å§‹å°å…¥</button>
                </div>
                <div id="importProgress" style="margin-top: 20px; display: none;">
                    <div style="width: 100%; background-color: #f0f0f0; border-radius: 4px;">
                        <div id="importProgressBar" style="width: 0%; height: 20px; background-color: #4CAF50; border-radius: 4px; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="importStatus" style="text-align: center; margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAaCC1v4YhL8d1sGjDgjIKumMbzzeydB9M",
            authDomain: "vipproject-1daf7.firebaseapp.com",
            projectId: "vipproject-1daf7",
            storageBucket: "vipproject-1daf7.appspot.com",
            messagingSenderId: "38611408907",
            appId: "1:38611408907:web:91ba08924cc33d8758cf0e",
            measurementId: "G-FSE2CSC7NP"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase åˆå§‹åŒ–å®Œæˆ');
        const auth = firebase.auth();
        const db = firebase.firestore();

        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        async function checkIfStaff(uid) {
            console.log('æ­£åœ¨æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ï¼Œç”¨æˆ¶ UID:', uid);
            try {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæŒ‡å®šçš„ç®¡ç†å“¡ UID
                if (uid === 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    console.log('ä½¿ç”¨é è¨­ç®¡ç†å“¡ UID');
                    return true;
                }

                const officialRef = db.collection('official').doc('data');
                const officialDoc = await officialRef.get();
                
                if (!officialDoc.exists) {
                    console.log('official/data æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º...');
                    try {
                        // å‰µå»ºæ–‡ä»¶ä¸¦è¨­ç½®æŒ‡å®šçš„ UID ç‚ºç®¡ç†å“¡
                        await officialRef.set({
                            staffs: {
                                't4R9VmALi2SW2fTITmBAtlYDzq32': true
                            }
                        });
                        console.log('æˆåŠŸå‰µå»ºç®¡ç†å“¡æ–‡ä»¶');
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    } catch (createError) {
                        console.error('å‰µå»ºç®¡ç†å“¡æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', createError);
                        // å¦‚æœæ˜¯æŒ‡å®šçš„ç®¡ç†å“¡ UIDï¼Œå³ä½¿å‰µå»ºå¤±æ•—ä¹Ÿè¿”å› true
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    }
                }

                const data = officialDoc.data();
                console.log('ç²å–åˆ°çš„ç®¡ç†å“¡è³‡æ–™:', data);
                
                if (!data || !data.staffs) {
                    console.log('ç®¡ç†å“¡è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­ç®¡ç†å“¡');
                    return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                }

                const isStaff = data.staffs[uid] === true || uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                console.log('ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡:', isStaff);
                return isStaff;
            } catch (error) {
                console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­ç®¡ç†å“¡ UID
                return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
            }
        }

        // é›»å­éƒµä»¶ç™»å…¥
        document.getElementById('emailLogin').addEventListener('click', () => {
            console.log('é»æ“Šç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log('æº–å‚™ç™»å…¥ï¼Œé›»å­éƒµä»¶:', email);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((result) => {
                    console.log('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ', result);
                    hideLoginInterface();
                })
                .catch((error) => {
                    console.error('ç®¡ç†å“¡ç™»å…¥éŒ¯èª¤:', error);
                    alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
                });
        });

        // Google ç™»å…¥
        document.getElementById('googleLogin').addEventListener('click', () => {
            console.log('é–‹å§‹ Google ç™»å…¥æµç¨‹');
            const provider = new firebase.auth.GoogleAuthProvider();
            // è¨­ç½®ç™»å…¥è¦–çª—çš„é…ç½®
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('ç™»å…¥æˆåŠŸ', result);
                })
                .catch((error) => {
                    console.error('ç™»å…¥éŒ¯èª¤:', error);
                    // å¦‚æœæ˜¯å½ˆå‡ºè¦–çª—è¢«å°é–ï¼Œå˜—è©¦ä½¿ç”¨é‡å®šå‘æ–¹å¼
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
                        console.log('å˜—è©¦ä½¿ç”¨é‡å®šå‘æ–¹å¼ç™»å…¥');
                        return auth.signInWithRedirect(provider);
                    }
                    alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
                });
        });

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            console.log('ç™»å…¥ç‹€æ…‹è®Šæ›´:', user ? 'å·²ç™»å…¥' : 'æœªç™»å…¥');
            if (user) {
                try {
                    console.log('ç”¨æˆ¶è³‡è¨Š:', user);
                    hideLoginInterface();  // ç™»å…¥æˆåŠŸå¾Œéš±è—ç™»å…¥ä»‹é¢
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                    const isStaff = await checkIfStaff(user.uid);
                    
                    if (isStaff) {
                        // é¡¯ç¤ºç®¡ç†å“¡ä»‹é¢
                        showStaffInterface();
                        const savedTime = localStorage.getItem('reminderTime');
                        if (savedTime) {
                            setupReminder(savedTime);
                        }
                    } else {
                        // æª¢æŸ¥æœƒå“¡è³‡æ–™
                        const userProfileRef = db.collection('users').doc(user.uid)
                            .collection('data').doc('profile');
                        const userProfile = await userProfileRef.get();

                        if (!userProfile.exists) {
                            // å»ºç«‹æ–°æœƒå“¡è³‡æ–™
                            const timestamp = Date.now();
                            const barcode = `MEM${timestamp}`;
                            
                            // å…ˆå»ºç«‹ profile æ–‡æª”
                            await userProfileRef.set({
                                role: 'customer',
                                email: user.email,
                                barcode: barcode,
                                name: '',
                                idNumber: '',
                                birthDate: '',
                                phone: '',
                                nationality: '',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                isInfoComplete: false
                            });

                            console.log('æ–°æœƒå“¡è³‡æ–™å·²å»ºç«‹:', {
                                uid: user.uid,
                                barcode: barcode,
                                email: user.email
                            });
                        }
                        
                        showCustomerInterface(userProfile.exists ? userProfile.data() : 
                            (await userProfileRef.get()).data());
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert('ç™»å…¥æˆåŠŸ');
                }
            } else {
                showLoginInterface();
            }
        });

        // é¡¯ç¤ºæœƒå“¡ä»‹é¢
        function showCustomerInterface(userData) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.remove('hidden');
            document.getElementById('staffSection').classList.add('hidden');

            // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
            document.getElementById('memberEmailDisplay').textContent = userData.email;

            // å¡«å…¥ç¾æœ‰è³‡æ–™
            if (userData.isInfoComplete) {
                document.getElementById('name').value = userData.name || '';
                document.getElementById('idNumber').value = userData.idNumber || '';
                document.getElementById('birthDate').value = userData.birthDate || '';
                document.getElementById('phone').value = userData.phone || '';
                document.getElementById('nationality').value = userData.nationality || '';
                
                // åªæœ‰åœ¨è³‡æ–™å®Œæ•´çš„æƒ…æ³ä¸‹æ‰é¡¯ç¤ºæ¢ç¢¼
                showBarcode(userData.barcode);
            } else {
                document.getElementById('barcodeDisplay').classList.add('hidden');
            }
        }

        // ä¿®æ”¹æ¢ç¢¼é¡¯ç¤ºå‡½æ•¸ï¼ŒåŒæ™‚é¡¯ç¤ºå…©ç¨®æ ¼å¼
        function showBarcode(barcode) {
            const barcodeDisplay = document.getElementById('barcodeDisplay');
            document.getElementById('memberBarcodeDisplay').textContent = barcode;
            
            // å‰µå»ºå…©å€‹ canvas å…ƒç´ ï¼Œåˆ†åˆ¥é¡¯ç¤º CODE128 å’Œ CODE39
            const barcodeContainer = document.getElementById('barcodeContainer');
            barcodeContainer.innerHTML = `
                <div class="barcode-item">
                    <p>CODE128 æ ¼å¼</p>
                    <svg id="memberBarcode128"></svg>
                </div>
                <div class="barcode-item">
                    <p>CODE39 æ ¼å¼</p>
                    <svg id="memberBarcode39"></svg>
                </div>
            `;
            
            // ç”Ÿæˆ CODE128 æ¢ç¢¼
            JsBarcode("#memberBarcode128", barcode, {
                format: "CODE128",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            // ç”Ÿæˆ CODE39 æ¢ç¢¼
            JsBarcode("#memberBarcode39", barcode, {
                format: "CODE39",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            barcodeDisplay.classList.remove('hidden');
        }

        // é¡¯ç¤ºç®¡ç†å“¡ä»‹é¢
        function showStaffInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.remove('hidden');

            // ç¶å®šæœå°‹åŠŸèƒ½
            document.getElementById('searchBtn').addEventListener('click', searchMember);
        }

        // è‡ªå®šç¾©æç¤ºæ¡†å‡½æ•¸
        function showCustomAlert(message) {
            hideLoading(); // å…ˆéš±è—åŠ è¼‰å‹•ç•«
            
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            const confirmBtn = customAlert.querySelector('.confirm-btn');

            messageElement.textContent = message;
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';

            return new Promise((resolve) => {
                confirmBtn.onclick = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    resolve();
                };
            });
        }

        // ä¿®æ”¹æœå°‹æœƒå“¡å‡½æ•¸ä¸­çš„æç¤º
        async function searchMember() {
            const barcode = document.getElementById('searchBarcode').value.trim();
            const idNumber = document.getElementById('searchIdNumber').value.trim();

            if (!barcode && !idNumber) {
                await showCustomAlert('è«‹è¼¸å…¥æœƒå“¡æ¢ç¢¼æˆ–è­‰ä»¶è™Ÿç¢¼');
                return;
            }

            try {
                showLoading();
                console.log('é–‹å§‹æœå°‹æœƒå“¡:', { barcode, idNumber });
                
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                console.log('æœå°‹çµæœæ•¸é‡:', querySnapshot.size);

                document.getElementById('searchBarcode').value = '';
                document.getElementById('searchIdNumber').value = '';

                const foundDoc = querySnapshot.docs.find(doc => {
                    const data = doc.data();
                    if (barcode) {
                        return data.barcode === barcode;
                    }
                    if (idNumber) {
                        return data.idNumber === idNumber;
                    }
                    return false;
                });

                if (!foundDoc) {
                    console.log('æœªæ‰¾åˆ°æœƒå“¡');
                    await showCustomAlert('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                    document.getElementById('addVisitBtn').disabled = true;
                    return;
                }

                const userData = foundDoc.data();
                const userId = foundDoc.ref.parent.parent.id;

                console.log('æ‰¾åˆ°æœƒå“¡:', {
                    userId: userId,
                    barcode: userData.barcode,
                    name: userData.name,
                    idNumber: userData.idNumber
                });

                // å•Ÿç”¨å¢åŠ åˆ°è¨ªæ¬¡æ•¸æŒ‰éˆ•ä¸¦é‡æ–°ç¶å®šäº‹ä»¶
                const addVisitBtn = document.getElementById('addVisitBtn');
                addVisitBtn.disabled = false;
                addVisitBtn.onclick = function() {
                    console.log('å¢åŠ åˆ°è¨ªæ¬¡æ•¸æŒ‰éˆ•è¢«é»æ“Šï¼ˆå¾æœå°‹çµæœï¼‰');
                    addVisit();
                };
                
                // å„²å­˜ç•¶å‰æœå°‹åˆ°çš„æœƒå“¡è³‡æ–™
                window.currentSearchedMember = {
                    userId: userId,
                    barcode: userData.barcode
                };

                // é¡¯ç¤ºæœƒå“¡è©³æƒ…
                await viewMemberDetails(userId);
                
                console.log('æœå°‹æµç¨‹å®Œæˆ');
            } catch (error) {
                console.error('æœå°‹æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('æœå°‹å¤±æ•—ï¼š' + error.message);
                document.getElementById('addVisitBtn').disabled = true;
            } finally {
                hideLoading();
            }
        }

        // æŸ¥çœ‹æœƒå“¡è©³æƒ…
        async function viewMemberDetails(userId) {
            try {
                showLoading(); // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                console.log('é–‹å§‹æŸ¥çœ‹æœƒå“¡è©³æƒ…ï¼Œç”¨æˆ¶ ID:', userId);

                // ä½¿ç”¨ UID ç›´æ¥æŸ¥è©¢
                const profileSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('data')
                    .doc('profile')
                    .get();

                if (!profileSnapshot.exists) {
                    console.log('æœªæ‰¾åˆ°æœƒå“¡è©³æƒ…');
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è©³æƒ…');
                    return;
                }

                const userData = profileSnapshot.data();

                console.log('é–‹å§‹è¼‰å…¥æœƒå“¡è©³ç´°è³‡è¨Š');

                // ç²å–è¨ªå•è¨˜éŒ„
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .orderBy('timestamp', 'desc')
                    .get();

                console.log('å–å¾—åˆ°è¨ªè¨˜éŒ„ï¼Œæ¬¡æ•¸:', visitsSnapshot.size);

                // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
                document.getElementById('customerBarcode').textContent = userData.barcode || '';
                document.getElementById('customerName').textContent = userData.name || '';
                document.getElementById('customerPhone').textContent = userData.phone || '';
                document.getElementById('customerEmail').textContent = userData.email || '';
                document.getElementById('customerIdNumber').textContent = userData.idNumber || '';
                document.getElementById('customerBirthDate').textContent = userData.birthDate || '';
                document.getElementById('customerNationality').textContent = userData.nationality || '';
                document.getElementById('visitCount').textContent = visitsSnapshot.size;

                // é¡¯ç¤ºè¨ªå•è¨˜éŒ„
                const visitHistory = document.getElementById('visitHistory');
                visitHistory.innerHTML = '';
                visitsSnapshot.forEach(visit => {
                    const visitDate = visit.data().timestamp.toDate();
                    const p = document.createElement('p');
                    p.textContent = visitDate.toLocaleString('zh-TW');
                    visitHistory.appendChild(p);
                });

                document.getElementById('customerInfo').classList.remove('hidden');
                console.log('æœƒå“¡è©³æƒ…é¡¯ç¤ºå®Œæˆ');
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                if (error.code === 'permission-denied') {
                    alert('æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹æœƒå“¡è©³æƒ…ã€‚è«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿã€‚');
                } else {
                    alert('è¼‰å…¥æœƒå“¡è©³æƒ…å¤±æ•—ï¼š' + error.message);
                }
            } finally {
                hideLoading(); // éš±è—è¼‰å…¥å‹•ç•«
            }
        }

        // é¡¯ç¤ºç™»å…¥ä»‹é¢
        function showLoginInterface() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.add('hidden');
        }

        // éš±è—ç™»å…¥ä»‹é¢
        function hideLoginInterface() {
            document.getElementById('loginSection').style.display = 'none';
        }

        // è™•ç†æœƒå“¡è³‡æ–™è¡¨å–®æäº¤
        document.getElementById('memberInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            try {
                showLoading();
                const userData = {
                    name: document.getElementById('name').value,
                    idNumber: document.getElementById('idNumber').value,
                    birthDate: document.getElementById('birthDate').value,
                    phone: document.getElementById('phone').value,
                    nationality: document.getElementById('nationality').value,
                    isInfoComplete: true
                };

                await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .update(userData);

                // ç²å–å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™
                const userProfile = await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .get();

                // é¡¯ç¤ºæ¢ç¢¼
                showBarcode(userProfile.data().barcode);
                
                await showCustomAlert('è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼ç¾åœ¨æ‚¨å¯ä»¥çœ‹åˆ°æ‚¨çš„æœƒå“¡æ¢ç¢¼ã€‚');
            } catch (error) {
                console.error("Error saving data:", error);
                await showCustomAlert('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            } finally {
                hideLoading();
            }
        });

        // ç™»å‡ºæŒ‰éˆ•
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('staffLogoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // é¡¯ç¤ºç®¡ç†å“¡ç™»å…¥å€åŸŸ
        document.getElementById('showAdminLogin').addEventListener('click', () => {
            console.log('é»æ“Šé¡¯ç¤ºç®¡ç†å“¡ç™»å…¥å€åŸŸæŒ‰éˆ•');
            const adminLoginSection = document.getElementById('adminLoginSection');
            const memberLoginSection = document.getElementById('memberLoginSection');
            
            // åˆ‡æ›ç®¡ç†å“¡ç™»å…¥å€åŸŸçš„é¡¯ç¤ºç‹€æ…‹
            adminLoginSection.classList.toggle('hidden');
            
            // å¦‚æœé¡¯ç¤ºç®¡ç†å“¡ç™»å…¥ï¼Œå‰‡éš±è—æœƒå“¡ç™»å…¥
            if (!adminLoginSection.classList.contains('hidden')) {
                memberLoginSection.classList.add('hidden');
            } else {
                memberLoginSection.classList.remove('hidden');
            }
            
            console.log('ç®¡ç†å“¡ç™»å…¥å€åŸŸé¡¯ç¤ºç‹€æ…‹:', !adminLoginSection.classList.contains('hidden'));
        });

        // åˆªé™¤æœƒå“¡ç›¸é—œè®Šæ•¸
        let currentDeletingMember = null;

        // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
        async function showDeleteConfirm() {
            const memberName = document.getElementById('customerName').textContent;
            const memberBarcode = document.getElementById('customerBarcode').textContent;
            currentDeletingMember = {
                barcode: memberBarcode,
                name: memberName
            };
            
            // ä½¿ç”¨è‡ªå®šç¾©æç¤ºæ¡†
            const confirmDelete = await new Promise(resolve => {
                const alertOverlay = document.querySelector('.alert-overlay');
                const customAlert = document.querySelector('.custom-alert');
                const messageElement = customAlert.querySelector('.message');
                const confirmBtn = customAlert.querySelector('.confirm-btn');
                
                messageElement.innerHTML = `ç¢ºå®šè¦åˆªé™¤æœƒå“¡ ${memberName} å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
                alertOverlay.style.display = 'block';
                customAlert.style.display = 'block';
                
                // ç§»é™¤ç¾æœ‰çš„å–æ¶ˆæŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingCancelBtn = customAlert.querySelector('.cancel-btn');
                if (existingCancelBtn) {
                    existingCancelBtn.remove();
                }
                
                // æ·»åŠ å–æ¶ˆæŒ‰éˆ•
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.className = 'confirm-btn cancel-btn';
                cancelBtn.style.marginLeft = '10px';
                cancelBtn.style.backgroundColor = '#6c757d';
                confirmBtn.parentNode.appendChild(cancelBtn);
                
                confirmBtn.textContent = 'ç¢ºèªåˆªé™¤';
                confirmBtn.style.backgroundColor = '#dc3545';
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                const cleanup = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    newCancelBtn.remove();
                    newConfirmBtn.style.backgroundColor = '';
                    newConfirmBtn.textContent = 'ç¢ºå®š';
                    // ç§»é™¤äº‹ä»¶ç›£è½å™¨
                    document.removeEventListener('keydown', handleKeyPress);
                };
                
                // è™•ç†éµç›¤äº‹ä»¶
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        cleanup();
                        resolve(true);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cleanup();
                        resolve(false);
                    }
                };
                
                // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.addEventListener('keydown', handleKeyPress);
                
                newConfirmBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                newCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                alertOverlay.onclick = (e) => {
                    if (e.target === alertOverlay) {
                        cleanup();
                        resolve(false);
                    }
                };
            });
            
            if (confirmDelete) {
                await deleteMember();
            }
        }

        // åˆªé™¤æœƒå“¡
        async function deleteMember() {
            if (!currentDeletingMember) return;

            try {
                showLoading();
                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                console.log('é–‹å§‹åˆªé™¤æœƒå“¡:', currentDeletingMember);

                // æœå°‹æœƒå“¡
                const querySnapshot = await db.collectionGroup('data')
                    .where('barcode', '==', currentDeletingMember.barcode)
                    .where('role', '==', 'customer')
                    .limit(1)
                    .get();

                if (querySnapshot.empty) {
                    throw new Error('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                }

                const userProfile = querySnapshot.docs[0];
                const userId = userProfile.ref.parent.parent.id;

                // åˆªé™¤æœƒå“¡æ‰€æœ‰è³‡æ–™
                const batch = db.batch();

                // åˆªé™¤ profile æ–‡æª”
                batch.delete(userProfile.ref);

                // åˆªé™¤è¨ªå•è¨˜éŒ„
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .get();

                visitsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // åŸ·è¡Œæ‰¹æ¬¡åˆªé™¤
                await batch.commit();

                await showCustomAlert(`æœƒå“¡ ${currentDeletingMember.name || currentDeletingMember.barcode} å·²æˆåŠŸåˆªé™¤`);
                
                // éš±è—æœƒå“¡è©³æƒ…
                document.getElementById('customerInfo').classList.add('hidden');
                currentDeletingMember = null;
            } catch (error) {
                console.error('åˆªé™¤æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('åˆªé™¤æœƒå“¡å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å¢åŠ åˆ°è¨ªæ¬¡æ•¸
        async function addVisit() {
            try {
                showLoading();
                console.log('é–‹å§‹å¢åŠ åˆ°è¨ªç´€éŒ„');
                console.log('ç•¶å‰æœå°‹åˆ°çš„æœƒå“¡:', window.currentSearchedMember);

                if (!window.currentSearchedMember) {
                    console.log('æœªæ‰¾åˆ°ç•¶å‰æœå°‹çš„æœƒå“¡è³‡æ–™');
                    hideLoading();
                    await showCustomAlert('è«‹å…ˆæœå°‹æœƒå“¡');
                    return;
                }

                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    hideLoading();
                    throw new Error('è«‹å…ˆç™»å…¥');
                }
                
                console.log('ç•¶å‰ç”¨æˆ¶:', currentUser.uid);
                
                if (currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    hideLoading();
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                const { userId, barcode } = window.currentSearchedMember;
                console.log('æº–å‚™å¢åŠ åˆ°è¨ªç´€éŒ„:', { userId, barcode });
            
                // ç›´æ¥å¢åŠ åˆ°è¨ªç´€éŒ„ï¼Œä¸éœ€è¦æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²åˆ°è¨ª
                const visitRef = await db.collection('users').doc(userId)
                    .collection('visits')
                    .add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        scannedBy: currentUser.uid
                    });

                console.log('åˆ°è¨ªç´€éŒ„å·²æ–°å¢:', visitRef.id);
                hideLoading();
                await showCustomAlert('å·²æˆåŠŸå¢åŠ åˆ°è¨ªç´€éŒ„ï¼');
                
                // é‡æ–°è¼‰å…¥æœƒå“¡è©³æƒ…
                console.log('é‡æ–°è¼‰å…¥æœƒå“¡è©³æƒ…');
                showLoading();
                await viewMemberDetails(userId);
                hideLoading();
            } catch (error) {
                console.error('å¢åŠ åˆ°è¨ªç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                hideLoading();
                await showCustomAlert('å¢åŠ åˆ°è¨ªç´€éŒ„å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ·»åŠ é¡¯ç¤ºå’Œéš±è—è¼‰å…¥å‹•ç•«çš„å‡½æ•¸
        function showLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
        }

        function hideLoading() {
            const loadingOverlay = document.querySelector('.loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
        }

        // æ–°å¢æœƒå“¡åŠŸèƒ½
        async function addNewMember() {
            try {
                showLoading();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const currentUser = auth.currentUser;
                if (!currentUser || currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–è¡¨å–®æ•¸æ“š
                const email = document.getElementById('newMemberEmail').value.trim();
                const name = document.getElementById('newMemberName').value.trim();
                const idNumber = document.getElementById('newMemberIdNumber').value.trim();
                const birthDate = document.getElementById('newMemberBirthDate').value;
                const phone = document.getElementById('newMemberPhone').value.trim();
                const nationality = document.getElementById('newMemberNationality').value.trim();

                // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆç§»é™¤ email çš„å¿…å¡«æª¢æŸ¥ï¼‰
                if (!name || !idNumber || !birthDate || !phone || !nationality) {
                    throw new Error('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆé›»å­éƒµä»¶ç‚ºé¸å¡«ï¼‰');
                }

                // å¦‚æœæœ‰å¡«å¯« emailï¼Œå‰‡æª¢æŸ¥æ ¼å¼
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
                }

                // ç”Ÿæˆæœƒå“¡æ¢ç¢¼
                const timestamp = Date.now();
                const barcode = `MEM${timestamp}`;

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è­‰ä»¶è™Ÿç¢¼
                const existingMemberQuery = await db.collectionGroup('data')
                    .where('idNumber', '==', idNumber)
                    .where('role', '==', 'customer')
                    .get();

                if (!existingMemberQuery.empty) {
                    throw new Error('æ­¤è­‰ä»¶è™Ÿç¢¼å·²è¢«è¨»å†Š');
                }

                // å‰µå»ºæ–°çš„æœƒå“¡æ–‡æª”
                const newMemberRef = db.collection('users').doc();
                await newMemberRef.collection('data').doc('profile').set({
                    role: 'customer',
                    email: email || '', // å¦‚æœæ²’æœ‰ email å‰‡è¨­ç‚ºç©ºå­—ä¸²
                    barcode: barcode,
                    name: name,
                    idNumber: idNumber,
                    birthDate: birthDate,
                    phone: phone,
                    nationality: nationality,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isInfoComplete: true
                });

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('newMemberEmail').value = '';
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberIdNumber').value = '';
                document.getElementById('newMemberBirthDate').value = '';
                document.getElementById('newMemberPhone').value = '';
                document.getElementById('newMemberNationality').value = '';

                await showCustomAlert(`æœƒå“¡æ–°å¢æˆåŠŸï¼\næœƒå“¡æ¢ç¢¼ï¼š${barcode}`);
            } catch (error) {
                console.error('æ–°å¢æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('æ–°å¢æœƒå“¡å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ–°å¢æœƒå“¡è¡¨å–®æ”¶åˆåŠŸèƒ½
        function toggleNewMemberForm() {
            const content = document.getElementById('newMemberForm');
            const icon = document.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // æœƒå“¡æ¸…å–®ç›¸é—œè®Šæ•¸
        let currentPage = 1;
        const membersPerPage = 10;
        let totalMembers = 0;
        let allMembers = [];

        // åˆ‡æ›æœƒå“¡æ¸…å–®é¡¯ç¤º
        function toggleMemberList() {
            const content = document.getElementById('memberListContent');
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                loadMemberList();
            }
        }

        // è¼‰å…¥æœƒå“¡æ¸…å–®
        async function loadMemberList() {
            try {
                showLoading();
                
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–æ‰€æœ‰æœƒå“¡è³‡æ–™
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                allMembers = await Promise.all(querySnapshot.docs.map(async doc => {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // ç²å–åˆ°è¨ªæ¬¡æ•¸
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    return {
                        ...userData,
                        userId: userId,
                        visitCount: visitsSnapshot.size
                    };
                }));

                totalMembers = allMembers.length;
                displayMemberList();
                updatePagination();
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('è¼‰å…¥æœƒå“¡æ¸…å–®å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // é¡¯ç¤ºæœƒå“¡æ¸…å–®
        function displayMemberList() {
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            const start = (currentPage - 1) * membersPerPage;
            const end = start + membersPerPage;
            const pageMembers = allMembers.slice(start, end);
            
            pageMembers.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${member.barcode || ''}</td>
                    <td>${member.name || ''}</td>
                    <td>${member.phone || ''}</td>
                    <td>${member.visitCount || 0}</td>
                    <td class="action-column">
                        <button class="view-btn" onclick="viewMemberDetails('${member.userId}')">æŸ¥çœ‹</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°åˆ†é æŒ‰éˆ•
        function updatePagination() {
            const pagination = document.getElementById('memberListPagination');
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é æŒ‰éˆ•
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é 
                </button>
            `;
            
            // é ç¢¼æŒ‰éˆ•
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" 
                            class="${currentPage === i ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // ä¸‹ä¸€é æŒ‰éˆ•
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é 
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // åˆ‡æ›é é¢
        function changePage(page) {
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayMemberList();
            updatePagination();
        }

        // è™•ç†æœå°‹æ¬„ä½çš„æŒ‰éµäº‹ä»¶
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchMember();
            }
        }

        // éŸ³æ•ˆåˆå§‹åŒ–
        const reminderSound = document.getElementById('reminderSound');
        const exportSound = document.getElementById('exportSound');

        // éŸ³æ•ˆæ’­æ”¾å‡½æ•¸
        function playReminderSound() {
            try {
                reminderSound.currentTime = 0;
                reminderSound.play().catch(error => {
                    console.log('æé†’éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('æé†’éŸ³æ•ˆæ’­æ”¾å‡ºéŒ¯:', error);
            }
        }

        function playExportSound() {
            try {
                exportSound.currentTime = 0;
                exportSound.play().catch(error => {
                    console.log('åŒ¯å‡ºéŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('åŒ¯å‡ºéŸ³æ•ˆæ’­æ”¾å‡ºéŒ¯:', error);
            }
        }

        // åœ¨é¡¯ç¤ºæé†’æ™‚æ’­æ”¾éŸ³æ•ˆ
        function showReminderDialog() {
            playReminderSound();
            // ... å…¶ä»–æé†’å°è©±æ¡†é¡¯ç¤ºé‚è¼¯ ...
        }

        // åœ¨åŒ¯å‡ºå®Œæˆæ™‚æ’­æ”¾éŸ³æ•ˆ
        function onExportComplete() {
            playExportSound();
            // ... å…¶ä»–åŒ¯å‡ºå®Œæˆé‚è¼¯ ...
        }

        // åŒ¯å‡ºæœƒå“¡è³‡æ–™åŠŸèƒ½
        async function exportMemberData() {
            try {
                showLoading();
                
                // æ’­æ”¾åŒ¯å‡ºéŸ³æ•ˆ
                playExportSound();
                
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    hideLoading();
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–æ‰€æœ‰æœƒå“¡è³‡æ–™
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                // æº–å‚™ TSV è³‡æ–™
                let tsvContent = 'æœƒå“¡æ¢ç¢¼\tå§“å\té›»è©±\té›»å­éƒµä»¶\tè­‰ä»¶è™Ÿç¢¼\tå‡ºç”Ÿå¹´æœˆæ—¥\tåœ‹ç±\tåˆ°è¨ªæ¬¡æ•¸\n';

                // è™•ç†æ¯å€‹æœƒå“¡çš„è³‡æ–™
                for (const doc of querySnapshot.docs) {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // ç²å–åˆ°è¨ªæ¬¡æ•¸
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    // å°‡è³‡æ–™åŠ å…¥ TSV
                    tsvContent += `${userData.barcode || ''}\t${userData.name || ''}\t${userData.phone || ''}\t${userData.email || ''}\t${userData.idNumber || ''}\t${userData.birthDate || ''}\t${userData.nationality || ''}\t${visitsSnapshot.size}\n`;
                }

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰
                const blob = new Blob(['\ufeff' + tsvContent], { type: 'text/tab-separated-values;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æœƒå“¡è³‡æ–™_${new Date().toLocaleDateString()}.tsv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                hideLoading();
                await showCustomAlert('å‚™ä»½å®Œæˆï¼');
            } catch (error) {
                console.error('åŒ¯å‡ºæœƒå“¡è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                hideLoading();
                await showCustomAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }

        // é¡¯ç¤ºæ’ç¨‹å°è©±æ¡†
        function showScheduleDialog() {
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            // è¨­ç½®å°è©±æ¡†å…§å®¹
            messageElement.innerHTML = `
                <h3>è¨­å®šå‚™ä»½æ™‚é–“</h3>
                <p>è«‹é¸æ“‡æ¯æ—¥æé†’å‚™ä»½æ™‚é–“ï¼š</p>
                <input type="time" id="reminderTime" value="${localStorage.getItem('reminderTime') || '09:00'}">
            `;
            
            // ä¿®æ”¹ç¢ºèªæŒ‰éˆ•
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = 'ç¢ºèª';
            
            // é¡¯ç¤ºå°è©±æ¡†
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
            confirmBtn.onclick = async () => {
                const time = document.getElementById('reminderTime').value;
                if (!time) {
                    await showCustomAlert('è«‹é¸æ“‡æé†’å‚™ä»½æ™‚é–“');
                    return;
                }
                
                // å„²å­˜è¨­å®š
                localStorage.setItem('reminderTime', time);
                setupReminder(time);
                
                // é—œé–‰å°è©±æ¡†
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                
                await showCustomAlert(`æé†’æ™‚é–“å·²è¨­å®šç‚º ${time}`);
            };
        }

        // è¨­ç½®æé†’
        function setupReminder(time) {
            // æ¸…é™¤ç¾æœ‰çš„æé†’
            if (window.reminderTimeout) {
                clearTimeout(window.reminderTimeout);
            }
            
            // è¨ˆç®—ä¸‹æ¬¡æé†’æ™‚é–“
            const [hours, minutes] = time.split(':').map(Number);
            const now = new Date();
            let next = new Date(now);
            next.setHours(hours, minutes, 0, 0);
            
            if (next <= now) {
                next.setDate(next.getDate() + 1);
            }
            
            // è¨­ç½®æé†’
            const delay = next.getTime() - now.getTime();
            window.reminderTimeout = setTimeout(() => {
                showReminderNotification();
                setupReminder(time); // è¨­ç½®ä¸‹ä¸€æ¬¡æé†’
            }, delay);
            
            console.log(`ä¸‹æ¬¡æé†’æ™‚é–“ï¼š${next.toLocaleString()}`);
        }

        // é¡¯ç¤ºæé†’é€šçŸ¥
        async function showReminderNotification() {
            playReminderSound();
            
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            messageElement.innerHTML = `
                <h3>å‚™ä»½æé†’</h3>
                <p>ç¾åœ¨æ˜¯å¦è¦å‚™ä»½è³‡æ–™ï¼Ÿ</p>
            `;
            
            // ä¿®æ”¹æŒ‰éˆ•
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = 'ç«‹å³å‚™ä»½';
            
            // æ·»åŠ å»¶å¾ŒæŒ‰éˆ•
            const postponeBtn = document.createElement('button');
            postponeBtn.textContent = 'ç¨å¾Œæé†’';
            postponeBtn.className = 'confirm-btn';
            postponeBtn.style.marginLeft = '10px';
            postponeBtn.style.backgroundColor = '#6c757d';
            confirmBtn.parentNode.appendChild(postponeBtn);
            
            // é¡¯ç¤ºå°è©±æ¡†
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            confirmBtn.onclick = async () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                await exportMemberData();
            };
            
            postponeBtn.onclick = () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                // 5 åˆ†é˜å¾Œå†æ¬¡æé†’
                setTimeout(showReminderNotification, 5 * 60 * 1000);
            };
        }

        // åœ¨ç™»å…¥å¾Œæ¢å¾©æé†’è¨­å®š
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const isStaff = await checkIfStaff(user.uid);
                if (isStaff) {
                    const savedTime = localStorage.getItem('reminderTime');
                    if (savedTime) {
                        setupReminder(savedTime);
                    }
                }
            }
        });

        // å ±è¡¨åˆ†æç›¸é—œå‡½æ•¸
        let memberGrowthChart = null;
        let visitFrequencyChart = null;
        let memberActivityChart = null;

        function toggleReportSection() {
            const content = document.getElementById('reportContent');
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                updateReports();
            }
        }

        async function updateReports() {
            try {
                const loading = document.querySelector('.report-loading');
                loading.style.display = 'flex';
                
                const days = parseInt(document.getElementById('reportDateRange').value);
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);

                // ç²å–æœƒå“¡è³‡æ–™
                const membersSnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                // ç²å–è¨ªå•è¨˜éŒ„
                const visitsSnapshot = await db.collectionGroup('visits')
                    .where('timestamp', '>=', startDate)
                    .where('timestamp', '<=', endDate)
                    .get();

                // è™•ç†è³‡æ–™
                const memberData = processMemberData(membersSnapshot, startDate);
                const visitData = processVisitData(visitsSnapshot, startDate, days);
                const activityData = processActivityData(visitsSnapshot, membersSnapshot);

                // æ›´æ–°åœ–è¡¨
                updateMemberGrowthChart(memberData);
                updateVisitFrequencyChart(visitData);
                updateMemberActivityChart(activityData);
            } catch (error) {
                console.error('æ›´æ–°å ±è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('æ›´æ–°å ±è¡¨å¤±æ•—ï¼š' + error.message);
            } finally {
                const loading = document.querySelector('.report-loading');
                loading.style.display = 'none';
            }
        }

        function processMemberData(snapshot, startDate) {
            const data = {
                labels: [],
                counts: []
            };

            // å¾ä»Šå¤©é–‹å§‹å¾€å›æ¨
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);  // è¨­å®šç‚ºä»Šå¤©çš„æœ€å¾Œä¸€åˆ»
            
            // åˆå§‹åŒ–æ¯å¤©çš„è³‡æ–™
            const dayData = {};
            const days = parseInt(document.getElementById('reportDateRange').value);  // ä½¿ç”¨é¸æ“‡çš„æ—¥æœŸç¯„åœ
            for (let i = days - 1; i >= 0; i--) {
                const currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() - i);
                const dayLabel = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                dayData[dayLabel] = 0;
            }

            // çµ±è¨ˆæ¯å¤©çš„æ–°å¢æœƒå“¡æ•¸
            snapshot.docs.forEach(doc => {
                const memberData = doc.data();
                const joinDate = memberData.createdAt?.toDate();
                if (joinDate && joinDate >= startDate && joinDate <= endDate) {
                    const dayLabel = `${joinDate.getMonth() + 1}/${joinDate.getDate()}`;
                    if (dayData.hasOwnProperty(dayLabel)) {
                        dayData[dayLabel]++;
                    }
                }
            });

            // è½‰æ›ç‚ºåœ–è¡¨è³‡æ–™ï¼Œä¿æŒæ™‚é–“é †åº
            Object.keys(dayData).forEach(dayLabel => {
                data.labels.push(dayLabel);
                data.counts.push(dayData[dayLabel]);
            });

            return data;
        }

        function processVisitData(snapshot, startDate, days) {
            const data = {
                labels: [],
                counts: []
            };

            // å¾ä»Šå¤©é–‹å§‹å¾€å›æ¨
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);  // è¨­å®šç‚ºä»Šå¤©çš„æœ€å¾Œä¸€åˆ»
            
            // åˆå§‹åŒ–æ¯å¤©çš„è³‡æ–™
            const dayData = {};
            for (let i = days - 1; i >= 0; i--) {
                const currentDate = new Date(endDate);
                currentDate.setDate(currentDate.getDate() - i);
                const dayLabel = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
                dayData[dayLabel] = 0;
            }

            // çµ±è¨ˆæ¯å¤©çš„è¨ªå•æ¬¡æ•¸
            snapshot.docs.forEach(doc => {
                const visitDate = doc.data().timestamp.toDate();
                if (visitDate >= startDate && visitDate <= endDate) {
                    const dayLabel = `${visitDate.getMonth() + 1}/${visitDate.getDate()}`;
                    if (dayData.hasOwnProperty(dayLabel)) {
                        dayData[dayLabel]++;
                    }
                }
            });

            // è½‰æ›ç‚ºåœ–è¡¨è³‡æ–™ï¼Œä¿æŒæ™‚é–“é †åº
            Object.keys(dayData).forEach(dayLabel => {
                data.labels.push(dayLabel);
                data.counts.push(dayData[dayLabel]);
            });

            return data;
        }

        function processActivityData(visitsSnapshot, membersSnapshot) {
            const memberVisits = {};
            visitsSnapshot.docs.forEach(doc => {
                const memberId = doc.ref.parent.parent.id;
                memberVisits[memberId] = (memberVisits[memberId] || 0) + 1;
            });

            const activityLevels = {
                'é«˜æ´»èºåº¦': 0,
                'ä¸­æ´»èºåº¦': 0,
                'ä½æ´»èºåº¦': 0
            };

            Object.values(memberVisits).forEach(visits => {
                if (visits >= 5) {
                    activityLevels['é«˜æ´»èºåº¦']++;
                } else if (visits >= 2) {
                    activityLevels['ä¸­æ´»èºåº¦']++;
                } else {
                    activityLevels['ä½æ´»èºåº¦']++;
                }
            });

            return {
                labels: Object.keys(activityLevels),
                counts: Object.values(activityLevels)
            };
        }

        function updateMemberGrowthChart(data) {
            const ctx = document.getElementById('memberGrowthChart').getContext('2d');
            
            if (memberGrowthChart) {
                memberGrowthChart.destroy();
            }

            memberGrowthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'æ¯é€±æ–°å¢æœƒå“¡æ•¸',
                        data: data.counts,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœƒå“¡é€±å¢é•·è¶¨å‹¢',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `æ–°å¢æœƒå“¡æ•¸ï¼š${context.raw} äºº`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'æ–°å¢æœƒå“¡æ•¸'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateVisitFrequencyChart(data) {
            const ctx = document.getElementById('visitFrequencyChart').getContext('2d');
            
            if (visitFrequencyChart) {
                visitFrequencyChart.destroy();
            }

            visitFrequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'æ¯æ—¥åˆ°è¨ªæ¬¡æ•¸',
                        data: data.counts,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ¯æ—¥åˆ°è¨ªé »ç‡åˆ†æ',
                            font: {
                                size: 16
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `åˆ°è¨ªæ¬¡æ•¸ï¼š${context.raw} æ¬¡`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'åˆ°è¨ªæ¬¡æ•¸'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¥æœŸ'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function updateMemberActivityChart(data) {
            const ctx = document.getElementById('memberActivityChart').getContext('2d');
            
            if (memberActivityChart) {
                memberActivityChart.destroy();
            }

            memberActivityChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.counts,
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(255, 206, 86, 0.5)',
                            'rgba(255, 99, 132, 0.5)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœƒå“¡æ´»èºåº¦åˆ†å¸ƒ'
                        }
                    }
                }
            });
        }

        // é¡¯ç¤ºå ±è¡¨åˆ†æå°è©±æ¡†
        async function showReportDialog() {
            try {
                showLoading();
                const dialog = document.querySelector('.report-dialog');
                dialog.style.display = 'block';
                await updateReports(); // è‡ªå‹•æ›´æ–°å ±è¡¨
            } catch (error) {
                console.error('é¡¯ç¤ºå ±è¡¨åˆ†ææ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('é¡¯ç¤ºå ±è¡¨åˆ†æå¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // éš±è—å ±è¡¨åˆ†æå°è©±æ¡†
        function hideReportDialog() {
            const dialog = document.querySelector('.report-dialog');
            dialog.style.display = 'none';
        }

        // å°å…¥æœƒå“¡è³‡æ–™ç›¸é—œå‡½æ•¸
        function importMemberData() {
            document.getElementById('importDialog').classList.remove('hidden');
        }

        function hideImportDialog() {
            document.getElementById('importDialog').classList.add('hidden');
            document.getElementById('importFile').value = '';
            document.getElementById('importProgress').style.display = 'none';
            document.getElementById('importProgressBar').style.width = '0%';
            document.getElementById('importStatus').textContent = '';
        }

        async function startImport() {
            try {
                showLoading();
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    await showCustomAlert('è«‹é¸æ“‡è¦å°å…¥çš„æª”æ¡ˆ');
                    return;
                }

                const updateExisting = document.getElementById('updateExisting').checked;
                const createNew = document.getElementById('createNew').checked;

                if (!updateExisting && !createNew) {
                    await showCustomAlert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å°å…¥é¸é …');
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const content = e.target.result;
                        const lines = content.split('\n');
                        
                        // æª¢æŸ¥æ¨™é¡Œè¡Œ
                        const headers = lines[0].split('\t');
                        const requiredHeaders = ['æœƒå“¡æ¢ç¢¼', 'å§“å', 'é›»è©±', 'é›»å­éƒµä»¶', 'è­‰ä»¶è™Ÿç¢¼', 'å‡ºç”Ÿå¹´æœˆæ—¥', 'åœ‹ç±', 'åˆ°è¨ªæ¬¡æ•¸'];
                        const missingHeaders = requiredHeaders.filter(header => !headers.includes(header));
                        
                        if (missingHeaders.length > 0) {
                            await showCustomAlert(`æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘å¿…è¦çš„æ¬„ä½ - ${missingHeaders.join(', ')}`);
                            return;
                        }

                        // é¡¯ç¤ºé€²åº¦æ¢
                        document.getElementById('importProgress').style.display = 'block';
                        const progressBar = document.getElementById('importProgressBar');
                        const statusText = document.getElementById('importStatus');

                        // è™•ç†æ¯ä¸€è¡Œæ•¸æ“š
                        let successCount = 0;
                        let errorCount = 0;
                        let totalCount = lines.length - 1; // æ¸›å»æ¨™é¡Œè¡Œ

                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;

                            const values = lines[i].split('\t');
                            const memberData = {
                                barcode: values[0],
                                name: values[1],
                                phone: values[2],
                                email: values[3],
                                idNumber: values[4],
                                birthDate: values[5],
                                nationality: values[6],
                                visitCount: parseInt(values[7]) || 0
                            };

                            try {
                                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè­‰ä»¶è™Ÿç¢¼çš„æœƒå“¡
                                const existingQuery = await db.collectionGroup('data')
                                    .where('idNumber', '==', memberData.idNumber)
                                    .where('role', '==', 'customer')
                                    .get();

                                if (!existingQuery.empty && updateExisting) {
                                    // æ›´æ–°ç¾æœ‰æœƒå“¡
                                    const existingDoc = existingQuery.docs[0];
                                    const userId = existingDoc.ref.parent.parent.id;
                                    
                                    // æ›´æ–°æœƒå“¡è³‡æ–™
                                    await existingDoc.ref.update({
                                        name: memberData.name,
                                        phone: memberData.phone,
                                        email: memberData.email,
                                        birthDate: memberData.birthDate,
                                        nationality: memberData.nationality,
                                        isInfoComplete: true
                                    });

                                    // æ›´æ–°åˆ°è¨ªæ¬¡æ•¸
                                    const currentVisits = await db.collection('users')
                                        .doc(userId)
                                        .collection('visits')
                                        .get();

                                    const visitsToAdd = memberData.visitCount - currentVisits.size;
                                    if (visitsToAdd > 0) {
                                        const batch = db.batch();
                                        for (let j = 0; j < visitsToAdd; j++) {
                                            const visitRef = db.collection('users')
                                                .doc(userId)
                                                .collection('visits')
                                                .doc();
                                            batch.set(visitRef, {
                                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                                scannedBy: auth.currentUser.uid
                                            });
                                        }
                                        await batch.commit();
                                    }
                                } else if (createNew) {
                                    // å‰µå»ºæ–°æœƒå“¡
                                    const newMemberRef = db.collection('users').doc();
                                    await newMemberRef.collection('data').doc('profile').set({
                                        role: 'customer',
                                        ...memberData,
                                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                        isInfoComplete: true
                                    });

                                    // æ·»åŠ è¨ªå•è¨˜éŒ„
                                    if (memberData.visitCount > 0) {
                                        const batch = db.batch();
                                        for (let j = 0; j < memberData.visitCount; j++) {
                                            const visitRef = db.collection('users')
                                                .doc(newMemberRef.id)
                                                .collection('visits')
                                                .doc();
                                            batch.set(visitRef, {
                                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                                scannedBy: auth.currentUser.uid
                                            });
                                        }
                                        await batch.commit();
                                    }
                                }

                                successCount++;
                            } catch (error) {
                                console.error(`è™•ç†ç¬¬ ${i} è¡Œæ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:`, error);
                                errorCount++;
                            }

                            // æ›´æ–°é€²åº¦æ¢
                            const progress = (i / totalCount) * 100;
                            progressBar.style.width = `${progress}%`;
                            statusText.textContent = `å·²è™•ç† ${i}/${totalCount} ç­†è³‡æ–™ (æˆåŠŸ: ${successCount}, å¤±æ•—: ${errorCount})`;
                        }

                        hideLoading();
                        await showCustomAlert(`å°å…¥å®Œæˆï¼\næˆåŠŸ: ${successCount} ç­†\nå¤±æ•—: ${errorCount} ç­†`);
                        hideImportDialog();
                    } catch (error) {
                        console.error('å°å…¥æ•¸æ“šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        hideLoading();
                        await showCustomAlert('å°å…¥å¤±æ•—ï¼š' + error.message);
                    }
                };

                reader.readAsText(file);
            } catch (error) {
                console.error('é–‹å§‹å°å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                hideLoading();
                await showCustomAlert('å°å…¥å¤±æ•—ï¼š' + error.message);
            }
        }
    </script>
</body>
</html>