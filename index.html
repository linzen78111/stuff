<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLç’½æ„›</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- HTML5 QRCode -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        .hidden {
            display: none !important;
        }
        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f5f5f5;
        }

        /* å¾Œå°ç®¡ç†ä»‹é¢æ¨£å¼ */
        #staffSection {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
        }
        
        #staffSection .search-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 600px;
        }

        #staffSection .search-section h2 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 20px;
            text-align: center;
        }

        #staffSection .search-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #staffSection .search-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #staffSection .search-form label {
            font-size: 16px;
            color: #333;
        }

        #staffSection .search-form input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        #staffSection .search-form .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #staffSection .search-form button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            background-color: #4285f4;
            color: white;
        }

        #staffSection .search-form button:hover {
            background-color: #357abd;
        }

        #staffSection .info-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #staffSection .info-table th,
        #staffSection .info-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #staffSection .info-table th {
            background-color: #f5f5f5;
            font-weight: normal;
            width: 120px;
        }

        #staffSection .action-btn {
            padding: 5px 15px;
            margin: 5px;
            border: none;
            cursor: pointer;
        }

        #staffSection #visitHistory {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #fff;
        }

        #staffSection #visitHistory p {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        #staffLogoutBtn {
            margin-top: 20px;
            padding: 5px 15px;
            background-color: #6c757d;
            color: white;
            border: none;
            cursor: pointer;
        }

        .delete-btn {
            background-color: #dc3545 !important;
            color: white;
        }

        /* æœƒå“¡ä»‹é¢æ¨£å¼ */
        #customerSection {
            max-width: 100%;
            padding: 10px;
        }

        #customerSection .form-group {
            margin: 20px 0;
        }

        #customerSection .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        #customerSection .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }

        #customerSection button {
            width: 100%;
            padding: 15px 25px;
            font-size: 16px;
            margin: 10px 0;
        }

        /* é€šç”¨æ¨£å¼ */
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        button:hover {
            background-color: #357abd;
        }

        .info-table {
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .info-table th, .info-table td {
            padding: 15px;
            border: 1px solid #ddd;
            text-align: left;
        }

        /* ç™»å…¥ä»‹é¢æ¨£å¼ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .google-login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            margin: 20px 0;
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-size: 16px;
        }

        .google-login-btn img {
            width: 24px;
            margin-right: 10px;
        }

        /* æ¢ç¢¼é¡¯ç¤ºæ¨£å¼ */
        .barcode-container {
            background-color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .barcode-item {
            margin: 20px 0;
            text-align: center;
        }

        .barcode-item svg {
            max-width: 100%;
            height: auto;
        }

        /* åˆªé™¤ç¢ºèªå°è©±æ¡†æ¨£å¼ */
        .modal {
            display: none;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆåƒ…é‡å°æœƒå“¡ä»‹é¢ï¼‰ */
        @media (max-width: 480px) {
            #customerSection {
                padding: 10px;
            }

            #customerSection .form-group label {
                font-size: 14px;
            }

            #customerSection .form-group input {
                font-size: 16px;
                padding: 10px;
            }

            #customerSection button {
                padding: 12px 20px;
                font-size: 16px;
            }

            .login-container {
                padding: 20px;
            }

            .login-container h2 {
                font-size: 20px;
            }
        }

        /* è¼‰å…¥å‹•ç•«æ¨£å¼ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-text {
            background-color: #fff;
            padding: 40px 80px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            font-size: 24px;
            color: #333;
            text-align: center;
            min-width: 300px;
            border: 1px solid #e0e0e0;
        }

        /* è‡ªå®šç¾©æç¤ºæ¡†æ¨£å¼ */
        .custom-alert {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 3000;
            text-align: center;
            min-width: 300px;
            border: 1px solid #e0e0e0;
        }

        .custom-alert .message {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .custom-alert .confirm-btn {
            padding: 10px 30px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .custom-alert .confirm-btn:hover {
            background-color: #357abd;
        }

        .alert-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2999;
        }

        /* æ–°å¢æœƒå“¡æ”¶åˆæŒ‰éˆ•æ¨£å¼ */
        .toggle-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 20px auto;
            max-width: 600px;
        }

        .toggle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .toggle-header h2 {
            margin: 0;
            color: #333;
            font-size: 20px;
        }

        .toggle-icon {
            font-size: 24px;
            transition: transform 0.3s ease;
        }

        .toggle-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .toggle-content.expanded {
            max-height: 1000px;
        }

        .toggle-icon.expanded {
            transform: rotate(180deg);
        }

        /* æœƒå“¡æ¸…å–®è¡¨æ ¼æ¨£å¼ */
        .member-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
        }

        .member-table th,
        .member-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
        }

        .member-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .member-table tr:hover {
            background-color: #f5f5f5;
        }

        .member-table .action-column {
            width: 100px;
            text-align: center;
        }

        .view-btn {
            padding: 5px 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .view-btn:hover {
            background-color: #357abd;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 5px 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            color: #333;
        }

        .pagination button:hover {
            background-color: #f5f5f5;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .pagination button.active {
            background-color: #4285f4;
            color: white;
            border-color: #4285f4;
        }
    </style>
</head>
<body>
    <!-- è‡ªå®šç¾©æç¤ºæ¡† -->
    <div class="alert-overlay"></div>
    <div class="custom-alert">
        <div class="message"></div>
        <button class="confirm-btn">ç¢ºå®š</button>
    </div>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading-overlay">
        <div class="loading-text">è³‡æ–™è™•ç†ä¸­,è«‹ç¨å€™...</div>
    </div>

    <!-- ç™»å…¥å€åŸŸ -->
    <div id="loginSection" class="login-overlay">
        <div class="login-container">
            <h2>SLç’½æ„›æ—…åº—<h2>
            <div id="adminLoginSection" class="hidden">
                <div class="form-group">
                    <label for="email">é›»å­éƒµä»¶ï¼š</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç¢¼ï¼š</label>
                    <input type="password" id="password" required>
                </div>
                <button id="emailLogin">ç™»å…¥ï¼ˆè¼¸å…¥å®Œè«‹æŒ‰é€™å€‹ï¼‰</button>
            </div>
            <div id="memberLoginSection">
                <p>è«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ä»¥ä½¿ç”¨æœƒå“¡åŠŸèƒ½</p>
                <button id="googleLogin" class="google-login-btn">
                    <img src="https://www.google.com/favicon.ico" alt="Google" style="width: 20px; margin-right: 10px;">
                    ä½¿ç”¨ Google ç™»å…¥
                </button>
            </div>
            <div class="admin-login-hint">
                <button id="showAdminLogin" class="text-button">ç®¡ç†å“¡ç™»å…¥</button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡è³‡æ–™å¡«å¯«å€åŸŸ -->
    <div id="customerSection" class="hidden">
        <h2>æœƒå“¡è³‡æ–™ï¼ˆcustomerï¼‰</h2>
        <div class="info-message">è«‹å…ˆå®Œæ•´å¡«å¯«æœƒå“¡è³‡æ–™æ‰èƒ½å–å¾—æœƒå“¡æ¢ç¢¼ Key your customer data to get your barcode</div>
        <form id="memberInfoForm">
            <div class="form-group">
                <label>é›»å­éƒµä»¶ï¼ˆemailï¼‰ï¼š</label>
                <span id="memberEmailDisplay"></span>
            </div>
            <div class="form-group">
                <label for="name">å§“åï¼ˆnameï¼‰</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="idNumber">è­‰ä»¶è™Ÿç¢¼ï¼ˆidNumberï¼‰</label>
                <input type="text" id="idNumber" required>
            </div>
            <div class="form-group">
                <label for="birthDate">å‡ºç”Ÿå¹´æœˆæ—¥ï¼ˆbirthDateï¼‰</label>
                <input type="date" id="birthDate" required>
            </div>
            <div class="form-group">
                <label for="phone">é›»è©±è™Ÿç¢¼ï¼ˆphoneï¼‰</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label for="nationality">åœ‹ç±ï¼ˆnationalityï¼‰</label>
                <input type="text" id="nationality" required>
            </div>
            <button type="submit" class="submit-btn">å„²å­˜è³‡æ–™ï¼ˆsaveï¼‰</button>
        </form>
        <div id="barcodeDisplay" class="hidden">
            <h3>æ‚¨çš„æœƒå“¡æ¢ç¢¼ï¼ˆbarcodeï¼‰</h3>
            <p class="barcode-notice">è«‹å¦¥å–„ä¿å­˜æ­¤æ¢ç¢¼ï¼Œæ¯æ¬¡åˆ°è¨ªæ™‚è«‹å‡ºç¤ºï¼ˆshowï¼‰</p>
            <div class="barcode-container">
                <div class="barcode-number">æ¢ç¢¼ç·¨è™Ÿï¼š<span id="memberBarcodeDisplay"></span></div>
                <div id="barcodeContainer"></div>
            </div>
        </div>
        <button id="logoutBtn">ç™»å‡ºï¼ˆlogoutï¼‰</button>
    </div>

    <!-- åº—å“¡ä»‹é¢ -->
    <div id="staffSection" class="hidden">
        <h2>å¾Œå°</h2>
        
        <!-- åŠŸèƒ½æŒ‰éˆ•å€åŸŸ -->
        <div class="toggle-section">
            <div class="button-group" style="margin: 15px 0; display: flex; gap: 15px;">
                <button onclick="exportMemberData()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #4CAF50; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">ğŸ“Š</span>
                    åŒ¯å‡ºæœƒå“¡è³‡æ–™
                </button>
                <button onclick="showScheduleDialog()" style="flex: 1; padding: 15px; font-size: 16px; background-color: #2196F3; transition: all 0.3s ease; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <span style="display: block; font-size: 24px; margin-bottom: 5px;">â°</span>
                    è¨­å®šæé†’æ™‚é–“
                </button>
            </div>
        </div>
        
        <!-- æœƒå“¡æ¸…å–®å€åŸŸ -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleMemberList()">
                <h2>æœƒå“¡æ¸…å–®</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="toggle-content" id="memberListContent">
                <div class="member-list-container">
                    <table class="member-table">
                        <thead>
                            <tr>
                                <th>æœƒå“¡æ¢ç¢¼</th>
                                <th>å§“å</th>
                                <th>é›»è©±</th>
                                <th>åˆ°è¨ªæ¬¡æ•¸</th>
                                <th class="action-column">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody">
                            <!-- æœƒå“¡è³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                        </tbody>
                    </table>
                    <div class="pagination" id="memberListPagination">
                        <!-- åˆ†é æŒ‰éˆ•å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢æœƒå“¡å€åŸŸ -->
        <div class="toggle-section">
            <div class="toggle-header" onclick="toggleNewMemberForm()">
                <h2>æ–°å¢æœƒå“¡</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="toggle-content" id="newMemberForm">
                <div class="search-form">
                    <div class="form-group">
                        <label for="newMemberEmail">é›»å­éƒµä»¶ï¼š</label>
                        <input type="email" id="newMemberEmail" placeholder="è«‹è¼¸å…¥æœƒå“¡é›»å­éƒµä»¶">
                    </div>
                    <div class="form-group">
                        <label for="newMemberName">å§“åï¼š</label>
                        <input type="text" id="newMemberName" placeholder="è«‹è¼¸å…¥æœƒå“¡å§“å">
                    </div>
                    <div class="form-group">
                        <label for="newMemberIdNumber">è­‰ä»¶è™Ÿç¢¼ï¼š</label>
                        <input type="text" id="newMemberIdNumber" placeholder="è«‹è¼¸å…¥è­‰ä»¶è™Ÿç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberBirthDate">å‡ºç”Ÿå¹´æœˆæ—¥ï¼š</label>
                        <input type="date" id="newMemberBirthDate">
                    </div>
                    <div class="form-group">
                        <label for="newMemberPhone">é›»è©±è™Ÿç¢¼ï¼š</label>
                        <input type="tel" id="newMemberPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
                    </div>
                    <div class="form-group">
                        <label for="newMemberNationality">åœ‹ç±ï¼š</label>
                        <input type="text" id="newMemberNationality" placeholder="è«‹è¼¸å…¥åœ‹ç±">
                    </div>
                    <div class="button-group">
                        <button onclick="addNewMember()">æ–°å¢æœƒå“¡</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æœå°‹å€åŸŸ -->
        <div class="search-section">
            <h2>æœƒå“¡æœå°‹</h2>
            <div class="search-form">
                <div class="form-group">
                    <label for="searchBarcode">æœƒå“¡æ¢ç¢¼ï¼š</label>
                    <input type="text" id="searchBarcode" placeholder="è«‹è¼¸å…¥æœƒå“¡æ¢ç¢¼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="form-group">
                    <label for="searchIdNumber">è­‰ä»¶è™Ÿç¢¼ï¼š</label>
                    <input type="text" id="searchIdNumber" placeholder="è«‹è¼¸å…¥è­‰ä»¶è™Ÿç¢¼" onkeypress="handleSearchKeyPress(event)">
                </div>
                <div class="button-group">
                    <button onclick="searchMember()">æœå°‹</button>
                    <button id="addVisitBtn" disabled onclick="addVisit()">å¢åŠ åˆ°è¨ªæ¬¡æ•¸</button>
                </div>
            </div>
        </div>

        <!-- æœƒå“¡è©³ç´°è³‡æ–™ -->
        <div id="customerInfo" class="hidden">
            <h3>æœƒå“¡è©³ç´°è³‡æ–™</h3>
            <table class="info-table">
                <tr><th>æœƒå“¡æ¢ç¢¼</th><td id="customerBarcode"></td></tr>
                <tr><th>å§“å</th><td id="customerName"></td></tr>
                <tr><th>é›»è©±</th><td id="customerPhone"></td></tr>
                <tr><th>é›»å­éƒµä»¶</th><td id="customerEmail"></td></tr>
                <tr><th>è­‰ä»¶è™Ÿç¢¼</th><td id="customerIdNumber"></td></tr>
                <tr><th>å‡ºç”Ÿå¹´æœˆæ—¥</th><td id="customerBirthDate"></td></tr>
                <tr><th>åœ‹ç±</th><td id="customerNationality"></td></tr>
                <tr><th>åˆ°è¨ªæ¬¡æ•¸</th><td id="visitCount"></td></tr>
            </table>
            <div style="margin: 20px 0;">
                <button class="action-btn delete-btn" onclick="showDeleteConfirm()">åˆªé™¤æœƒå“¡</button>
            </div>
            <h4>åˆ°è¨ªè¨˜éŒ„</h4>
            <div id="visitHistory"></div>
        </div>

        <button id="staffLogoutBtn">ç™»å‡º</button>
    </div>

    <!-- æ·»åŠ éŸ³æ•ˆå…ƒç´  -->
    <audio id="reminderSound" preload="auto">
        <source src="SystemMessage_warning1.wav" type="audio/wav">
    </audio>
    <audio id="exportSound" preload="auto">
        <source src="SystemMessage_warning2.wav" type="audio/wav">
    </audio>

    <script>
        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyAaCC1v4YhL8d1sGjDgjIKumMbzzeydB9M",
            authDomain: "vipproject-1daf7.firebaseapp.com",
            projectId: "vipproject-1daf7",
            storageBucket: "vipproject-1daf7.appspot.com",
            messagingSenderId: "38611408907",
            appId: "1:38611408907:web:91ba08924cc33d8758cf0e",
            measurementId: "G-FSE2CSC7NP"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase åˆå§‹åŒ–å®Œæˆ');
        const auth = firebase.auth();
        const db = firebase.firestore();

        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
        async function checkIfStaff(uid) {
            console.log('æ­£åœ¨æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™ï¼Œç”¨æˆ¶ UID:', uid);
            try {
                // æª¢æŸ¥æ˜¯å¦ç‚ºæŒ‡å®šçš„ç®¡ç†å“¡ UID
                if (uid === 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    console.log('ä½¿ç”¨é è¨­ç®¡ç†å“¡ UID');
                    return true;
                }

                const officialRef = db.collection('official').doc('data');
                const officialDoc = await officialRef.get();
                
                if (!officialDoc.exists) {
                    console.log('official/data æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º...');
                    try {
                        // å‰µå»ºæ–‡ä»¶ä¸¦è¨­ç½®æŒ‡å®šçš„ UID ç‚ºç®¡ç†å“¡
                        await officialRef.set({
                            staffs: {
                                't4R9VmALi2SW2fTITmBAtlYDzq32': true
                            }
                        });
                        console.log('æˆåŠŸå‰µå»ºç®¡ç†å“¡æ–‡ä»¶');
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    } catch (createError) {
                        console.error('å‰µå»ºç®¡ç†å“¡æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', createError);
                        // å¦‚æœæ˜¯æŒ‡å®šçš„ç®¡ç†å“¡ UIDï¼Œå³ä½¿å‰µå»ºå¤±æ•—ä¹Ÿè¿”å› true
                        return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                    }
                }

                const data = officialDoc.data();
                console.log('ç²å–åˆ°çš„ç®¡ç†å“¡è³‡æ–™:', data);
                
                if (!data || !data.staffs) {
                    console.log('ç®¡ç†å“¡è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­ç®¡ç†å“¡');
                    return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                }

                const isStaff = data.staffs[uid] === true || uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
                console.log('ç”¨æˆ¶æ˜¯å¦ç‚ºç®¡ç†å“¡:', isStaff);
                return isStaff;
            } catch (error) {
                console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // å¦‚æœç™¼ç”ŸéŒ¯èª¤ï¼Œæª¢æŸ¥æ˜¯å¦ç‚ºé è¨­ç®¡ç†å“¡ UID
                return uid === 't4R9VmALi2SW2fTITmBAtlYDzq32';
            }
        }

        // é›»å­éƒµä»¶ç™»å…¥
        document.getElementById('emailLogin').addEventListener('click', () => {
            console.log('é»æ“Šç®¡ç†å“¡ç™»å…¥æŒ‰éˆ•');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            console.log('æº–å‚™ç™»å…¥ï¼Œé›»å­éƒµä»¶:', email);
            
            auth.signInWithEmailAndPassword(email, password)
                .then((result) => {
                    console.log('ç®¡ç†å“¡ç™»å…¥æˆåŠŸ', result);
                    hideLoginInterface();
                })
                .catch((error) => {
                    console.error('ç®¡ç†å“¡ç™»å…¥éŒ¯èª¤:', error);
                    alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
                });
        });

        // Google ç™»å…¥
        document.getElementById('googleLogin').addEventListener('click', () => {
            console.log('é–‹å§‹ Google ç™»å…¥æµç¨‹');
            const provider = new firebase.auth.GoogleAuthProvider();
            // è¨­ç½®ç™»å…¥è¦–çª—çš„é…ç½®
            provider.setCustomParameters({
                prompt: 'select_account'
            });
            
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('ç™»å…¥æˆåŠŸ', result);
                })
                .catch((error) => {
                    console.error('ç™»å…¥éŒ¯èª¤:', error);
                    // å¦‚æœæ˜¯å½ˆå‡ºè¦–çª—è¢«å°é–ï¼Œå˜—è©¦ä½¿ç”¨é‡å®šå‘æ–¹å¼
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/popup-closed-by-user') {
                        console.log('å˜—è©¦ä½¿ç”¨é‡å®šå‘æ–¹å¼ç™»å…¥');
                        return auth.signInWithRedirect(provider);
                    }
                    alert('ç™»å…¥å¤±æ•—ï¼š' + error.message);
                });
        });

        // ç›£è½ç™»å…¥ç‹€æ…‹
        auth.onAuthStateChanged(async (user) => {
            console.log('ç™»å…¥ç‹€æ…‹è®Šæ›´:', user ? 'å·²ç™»å…¥' : 'æœªç™»å…¥');
            if (user) {
                try {
                    console.log('ç”¨æˆ¶è³‡è¨Š:', user);
                    hideLoginInterface();  // ç™»å…¥æˆåŠŸå¾Œéš±è—ç™»å…¥ä»‹é¢
                    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                    const isStaff = await checkIfStaff(user.uid);
                    
                    if (isStaff) {
                        // é¡¯ç¤ºç®¡ç†å“¡ä»‹é¢
                        showStaffInterface();
                        const savedTime = localStorage.getItem('reminderTime');
                        if (savedTime) {
                            setupReminder(savedTime);
                        }
                    } else {
                        // æª¢æŸ¥æœƒå“¡è³‡æ–™
                        const userProfileRef = db.collection('users').doc(user.uid)
                            .collection('data').doc('profile');
                        const userProfile = await userProfileRef.get();

                        if (!userProfile.exists) {
                            // å»ºç«‹æ–°æœƒå“¡è³‡æ–™
                            const timestamp = Date.now();
                            const barcode = `MEM${timestamp}`;
                            
                            // å…ˆå»ºç«‹ profile æ–‡æª”
                            await userProfileRef.set({
                                role: 'customer',
                                email: user.email,
                                barcode: barcode,
                                name: '',
                                idNumber: '',
                                birthDate: '',
                                phone: '',
                                nationality: '',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                isInfoComplete: false
                            });

                            console.log('æ–°æœƒå“¡è³‡æ–™å·²å»ºç«‹:', {
                                uid: user.uid,
                                barcode: barcode,
                                email: user.email
                            });
                        }
                        
                        showCustomerInterface(userProfile.exists ? userProfile.data() : 
                            (await userProfileRef.get()).data());
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert('ç™»å…¥æˆåŠŸ');
                }
            } else {
                showLoginInterface();
            }
        });

        // é¡¯ç¤ºæœƒå“¡ä»‹é¢
        function showCustomerInterface(userData) {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.remove('hidden');
            document.getElementById('staffSection').classList.add('hidden');

            // é¡¯ç¤ºåŸºæœ¬è³‡è¨Š
            document.getElementById('memberEmailDisplay').textContent = userData.email;

            // å¡«å…¥ç¾æœ‰è³‡æ–™
            if (userData.isInfoComplete) {
                document.getElementById('name').value = userData.name || '';
                document.getElementById('idNumber').value = userData.idNumber || '';
                document.getElementById('birthDate').value = userData.birthDate || '';
                document.getElementById('phone').value = userData.phone || '';
                document.getElementById('nationality').value = userData.nationality || '';
                
                // åªæœ‰åœ¨è³‡æ–™å®Œæ•´çš„æƒ…æ³ä¸‹æ‰é¡¯ç¤ºæ¢ç¢¼
                showBarcode(userData.barcode);
            } else {
                document.getElementById('barcodeDisplay').classList.add('hidden');
            }
        }

        // ä¿®æ”¹æ¢ç¢¼é¡¯ç¤ºå‡½æ•¸ï¼ŒåŒæ™‚é¡¯ç¤ºå…©ç¨®æ ¼å¼
        function showBarcode(barcode) {
            const barcodeDisplay = document.getElementById('barcodeDisplay');
            document.getElementById('memberBarcodeDisplay').textContent = barcode;
            
            // å‰µå»ºå…©å€‹ canvas å…ƒç´ ï¼Œåˆ†åˆ¥é¡¯ç¤º CODE128 å’Œ CODE39
            const barcodeContainer = document.getElementById('barcodeContainer');
            barcodeContainer.innerHTML = `
                <div class="barcode-item">
                    <p>CODE128 æ ¼å¼</p>
                    <svg id="memberBarcode128"></svg>
                </div>
                <div class="barcode-item">
                    <p>CODE39 æ ¼å¼</p>
                    <svg id="memberBarcode39"></svg>
                </div>
            `;
            
            // ç”Ÿæˆ CODE128 æ¢ç¢¼
            JsBarcode("#memberBarcode128", barcode, {
                format: "CODE128",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            // ç”Ÿæˆ CODE39 æ¢ç¢¼
            JsBarcode("#memberBarcode39", barcode, {
                format: "CODE39",
                width: 2,
                height: 100,
                displayValue: true,
                text: barcode
            });
            
            barcodeDisplay.classList.remove('hidden');
        }

        // é¡¯ç¤ºç®¡ç†å“¡ä»‹é¢
        function showStaffInterface() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.remove('hidden');

            // ç¶å®šæœå°‹åŠŸèƒ½
            document.getElementById('searchBtn').addEventListener('click', searchMember);
        }

        // è‡ªå®šç¾©æç¤ºæ¡†å‡½æ•¸
        function showCustomAlert(message) {
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            const confirmBtn = customAlert.querySelector('.confirm-btn');

            messageElement.textContent = message;
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';

            return new Promise((resolve) => {
                confirmBtn.onclick = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    resolve();
                };
            });
        }

        // ä¿®æ”¹æœå°‹æœƒå“¡å‡½æ•¸ä¸­çš„æç¤º
        async function searchMember() {
            const barcode = document.getElementById('searchBarcode').value.trim();
            const idNumber = document.getElementById('searchIdNumber').value.trim();

            if (!barcode && !idNumber) {
                await showCustomAlert('è«‹è¼¸å…¥æœƒå“¡æ¢ç¢¼æˆ–è­‰ä»¶è™Ÿç¢¼');
                return;
            }

            try {
                showLoading();
                console.log('é–‹å§‹æœå°‹æœƒå“¡:', { barcode, idNumber });
                
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                console.log('æœå°‹çµæœæ•¸é‡:', querySnapshot.size);

                document.getElementById('searchBarcode').value = '';
                document.getElementById('searchIdNumber').value = '';

                const foundDoc = querySnapshot.docs.find(doc => {
                    const data = doc.data();
                    if (barcode) {
                        return data.barcode === barcode;
                    }
                    if (idNumber) {
                        return data.idNumber === idNumber;
                    }
                    return false;
                });

                if (!foundDoc) {
                    console.log('æœªæ‰¾åˆ°æœƒå“¡');
                    await showCustomAlert('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                    document.getElementById('addVisitBtn').disabled = true;
                    return;
                }

                const userData = foundDoc.data();
                const userId = foundDoc.ref.parent.parent.id;

                console.log('æ‰¾åˆ°æœƒå“¡:', {
                    userId: userId,
                    barcode: userData.barcode,
                    name: userData.name,
                    idNumber: userData.idNumber
                });

                // å•Ÿç”¨å¢åŠ åˆ°è¨ªæ¬¡æ•¸æŒ‰éˆ•ä¸¦é‡æ–°ç¶å®šäº‹ä»¶
                const addVisitBtn = document.getElementById('addVisitBtn');
                addVisitBtn.disabled = false;
                addVisitBtn.onclick = function() {
                    console.log('å¢åŠ åˆ°è¨ªæ¬¡æ•¸æŒ‰éˆ•è¢«é»æ“Šï¼ˆå¾æœå°‹çµæœï¼‰');
                    addVisit();
                };
                
                // å„²å­˜ç•¶å‰æœå°‹åˆ°çš„æœƒå“¡è³‡æ–™
                window.currentSearchedMember = {
                    userId: userId,
                    barcode: userData.barcode
                };

                // é¡¯ç¤ºæœƒå“¡è©³æƒ…
                await viewMemberDetails(userId);
                
                console.log('æœå°‹æµç¨‹å®Œæˆ');
            } catch (error) {
                console.error('æœå°‹æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('æœå°‹å¤±æ•—ï¼š' + error.message);
                document.getElementById('addVisitBtn').disabled = true;
            } finally {
                hideLoading();
            }
        }

        // æŸ¥çœ‹æœƒå“¡è©³æƒ…
        async function viewMemberDetails(userId) {
            try {
                showLoading(); // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                console.log('é–‹å§‹æŸ¥çœ‹æœƒå“¡è©³æƒ…ï¼Œç”¨æˆ¶ ID:', userId);

                // ä½¿ç”¨ UID ç›´æ¥æŸ¥è©¢
                const profileSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('data')
                    .doc('profile')
                    .get();

                if (!profileSnapshot.exists) {
                    console.log('æœªæ‰¾åˆ°æœƒå“¡è©³æƒ…');
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è©³æƒ…');
                    return;
                }

                const userData = profileSnapshot.data();

                console.log('é–‹å§‹è¼‰å…¥æœƒå“¡è©³ç´°è³‡è¨Š');

                // ç²å–è¨ªå•è¨˜éŒ„
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .orderBy('timestamp', 'desc')
                    .get();

                console.log('å–å¾—åˆ°è¨ªè¨˜éŒ„ï¼Œæ¬¡æ•¸:', visitsSnapshot.size);

                // é¡¯ç¤ºæœƒå“¡è³‡è¨Š
                document.getElementById('customerBarcode').textContent = userData.barcode || '';
                document.getElementById('customerName').textContent = userData.name || '';
                document.getElementById('customerPhone').textContent = userData.phone || '';
                document.getElementById('customerEmail').textContent = userData.email || '';
                document.getElementById('customerIdNumber').textContent = userData.idNumber || '';
                document.getElementById('customerBirthDate').textContent = userData.birthDate || '';
                document.getElementById('customerNationality').textContent = userData.nationality || '';
                document.getElementById('visitCount').textContent = visitsSnapshot.size;

                // é¡¯ç¤ºè¨ªå•è¨˜éŒ„
                const visitHistory = document.getElementById('visitHistory');
                visitHistory.innerHTML = '';
                visitsSnapshot.forEach(visit => {
                    const visitDate = visit.data().timestamp.toDate();
                    const p = document.createElement('p');
                    p.textContent = visitDate.toLocaleString('zh-TW');
                    visitHistory.appendChild(p);
                });

                document.getElementById('customerInfo').classList.remove('hidden');
                console.log('æœƒå“¡è©³æƒ…é¡¯ç¤ºå®Œæˆ');
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è©³æƒ…æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                if (error.code === 'permission-denied') {
                    alert('æ‚¨æ²’æœ‰æ¬Šé™æŸ¥çœ‹æœƒå“¡è©³æƒ…ã€‚è«‹ç¢ºä¿æ‚¨å·²ç™»å…¥ç®¡ç†å“¡å¸³è™Ÿã€‚');
                } else {
                    alert('è¼‰å…¥æœƒå“¡è©³æƒ…å¤±æ•—ï¼š' + error.message);
                }
            } finally {
                hideLoading(); // éš±è—è¼‰å…¥å‹•ç•«
            }
        }

        // é¡¯ç¤ºç™»å…¥ä»‹é¢
        function showLoginInterface() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('customerSection').classList.add('hidden');
            document.getElementById('staffSection').classList.add('hidden');
        }

        // éš±è—ç™»å…¥ä»‹é¢
        function hideLoginInterface() {
            document.getElementById('loginSection').style.display = 'none';
        }

        // è™•ç†æœƒå“¡è³‡æ–™è¡¨å–®æäº¤
        document.getElementById('memberInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            try {
                showLoading();
                const userData = {
                    name: document.getElementById('name').value,
                    idNumber: document.getElementById('idNumber').value,
                    birthDate: document.getElementById('birthDate').value,
                    phone: document.getElementById('phone').value,
                    nationality: document.getElementById('nationality').value,
                    isInfoComplete: true
                };

                await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .update(userData);

                // ç²å–å®Œæ•´çš„ç”¨æˆ¶è³‡æ–™
                const userProfile = await db.collection('users').doc(user.uid)
                    .collection('data').doc('profile')
                    .get();

                // é¡¯ç¤ºæ¢ç¢¼
                showBarcode(userProfile.data().barcode);
                
                await showCustomAlert('è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼ç¾åœ¨æ‚¨å¯ä»¥çœ‹åˆ°æ‚¨çš„æœƒå“¡æ¢ç¢¼ã€‚');
            } catch (error) {
                console.error("Error saving data:", error);
                await showCustomAlert('å„²å­˜è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
            } finally {
                hideLoading();
            }
        });

        // ç™»å‡ºæŒ‰éˆ•
        document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
        document.getElementById('staffLogoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        // é¡¯ç¤ºç®¡ç†å“¡ç™»å…¥å€åŸŸ
        document.getElementById('showAdminLogin').addEventListener('click', () => {
            console.log('é»æ“Šé¡¯ç¤ºç®¡ç†å“¡ç™»å…¥å€åŸŸæŒ‰éˆ•');
            const adminLoginSection = document.getElementById('adminLoginSection');
            const memberLoginSection = document.getElementById('memberLoginSection');
            
            // åˆ‡æ›ç®¡ç†å“¡ç™»å…¥å€åŸŸçš„é¡¯ç¤ºç‹€æ…‹
            adminLoginSection.classList.toggle('hidden');
            
            // å¦‚æœé¡¯ç¤ºç®¡ç†å“¡ç™»å…¥ï¼Œå‰‡éš±è—æœƒå“¡ç™»å…¥
            if (!adminLoginSection.classList.contains('hidden')) {
                memberLoginSection.classList.add('hidden');
            } else {
                memberLoginSection.classList.remove('hidden');
            }
            
            console.log('ç®¡ç†å“¡ç™»å…¥å€åŸŸé¡¯ç¤ºç‹€æ…‹:', !adminLoginSection.classList.contains('hidden'));
        });

        // åˆªé™¤æœƒå“¡ç›¸é—œè®Šæ•¸
        let currentDeletingMember = null;

        // é¡¯ç¤ºåˆªé™¤ç¢ºèªå°è©±æ¡†
        async function showDeleteConfirm() {
            const memberName = document.getElementById('customerName').textContent;
            const memberBarcode = document.getElementById('customerBarcode').textContent;
            currentDeletingMember = {
                barcode: memberBarcode,
                name: memberName
            };
            
            // ä½¿ç”¨è‡ªå®šç¾©æç¤ºæ¡†
            const confirmDelete = await new Promise(resolve => {
                const alertOverlay = document.querySelector('.alert-overlay');
                const customAlert = document.querySelector('.custom-alert');
                const messageElement = customAlert.querySelector('.message');
                const confirmBtn = customAlert.querySelector('.confirm-btn');
                
                messageElement.innerHTML = `ç¢ºå®šè¦åˆªé™¤æœƒå“¡ ${memberName} å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
                alertOverlay.style.display = 'block';
                customAlert.style.display = 'block';
                
                // ç§»é™¤ç¾æœ‰çš„å–æ¶ˆæŒ‰éˆ•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const existingCancelBtn = customAlert.querySelector('.cancel-btn');
                if (existingCancelBtn) {
                    existingCancelBtn.remove();
                }
                
                // æ·»åŠ å–æ¶ˆæŒ‰éˆ•
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'å–æ¶ˆ';
                cancelBtn.className = 'confirm-btn cancel-btn';
                cancelBtn.style.marginLeft = '10px';
                cancelBtn.style.backgroundColor = '#6c757d';
                confirmBtn.parentNode.appendChild(cancelBtn);
                
                confirmBtn.textContent = 'ç¢ºèªåˆªé™¤';
                confirmBtn.style.backgroundColor = '#dc3545';
                
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›£è½å™¨
                const newConfirmBtn = confirmBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                
                const cleanup = () => {
                    alertOverlay.style.display = 'none';
                    customAlert.style.display = 'none';
                    newCancelBtn.remove();
                    newConfirmBtn.style.backgroundColor = '';
                    newConfirmBtn.textContent = 'ç¢ºå®š';
                    // ç§»é™¤äº‹ä»¶ç›£è½å™¨
                    document.removeEventListener('keydown', handleKeyPress);
                };
                
                // è™•ç†éµç›¤äº‹ä»¶
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        cleanup();
                        resolve(true);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cleanup();
                        resolve(false);
                    }
                };
                
                // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                document.addEventListener('keydown', handleKeyPress);
                
                newConfirmBtn.onclick = () => {
                    cleanup();
                    resolve(true);
                };
                
                newCancelBtn.onclick = () => {
                    cleanup();
                    resolve(false);
                };
                
                alertOverlay.onclick = (e) => {
                    if (e.target === alertOverlay) {
                        cleanup();
                        resolve(false);
                    }
                };
            });
            
            if (confirmDelete) {
                await deleteMember();
            }
        }

        // åˆªé™¤æœƒå“¡
        async function deleteMember() {
            if (!currentDeletingMember) return;

            try {
                showLoading();
                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                console.log('é–‹å§‹åˆªé™¤æœƒå“¡:', currentDeletingMember);

                // æœå°‹æœƒå“¡
                const querySnapshot = await db.collectionGroup('data')
                    .where('barcode', '==', currentDeletingMember.barcode)
                    .where('role', '==', 'customer')
                    .limit(1)
                    .get();

                if (querySnapshot.empty) {
                    throw new Error('æ‰¾ä¸åˆ°æ­¤æœƒå“¡');
                }

                const userProfile = querySnapshot.docs[0];
                const userId = userProfile.ref.parent.parent.id;

                // åˆªé™¤æœƒå“¡æ‰€æœ‰è³‡æ–™
                const batch = db.batch();

                // åˆªé™¤ profile æ–‡æª”
                batch.delete(userProfile.ref);

                // åˆªé™¤è¨ªå•è¨˜éŒ„
                const visitsSnapshot = await db.collection('users')
                    .doc(userId)
                    .collection('visits')
                    .get();

                visitsSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // åŸ·è¡Œæ‰¹æ¬¡åˆªé™¤
                await batch.commit();

                await showCustomAlert(`æœƒå“¡ ${currentDeletingMember.name || currentDeletingMember.barcode} å·²æˆåŠŸåˆªé™¤`);
                
                // éš±è—æœƒå“¡è©³æƒ…
                document.getElementById('customerInfo').classList.add('hidden');
                currentDeletingMember = null;
            } catch (error) {
                console.error('åˆªé™¤æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('åˆªé™¤æœƒå“¡å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å¢åŠ åˆ°è¨ªæ¬¡æ•¸
        async function addVisit() {
            try {
                showLoading();
                console.log('é–‹å§‹å¢åŠ åˆ°è¨ªç´€éŒ„');
                console.log('ç•¶å‰æœå°‹åˆ°çš„æœƒå“¡:', window.currentSearchedMember);

                if (!window.currentSearchedMember) {
                    console.log('æœªæ‰¾åˆ°ç•¶å‰æœå°‹çš„æœƒå“¡è³‡æ–™');
                    await showCustomAlert('è«‹å…ˆæœå°‹æœƒå“¡');
                    return;
                }

                // å…ˆç¢ºèªæ˜¯å¦ç‚ºç®¡ç†å“¡
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('è«‹å…ˆç™»å…¥');
                }
                
                console.log('ç•¶å‰ç”¨æˆ¶:', currentUser.uid);
                
                if (currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                const { userId, barcode } = window.currentSearchedMember;
                console.log('æº–å‚™å¢åŠ åˆ°è¨ªç´€éŒ„:', { userId, barcode });
            
                // ç›´æ¥å¢åŠ åˆ°è¨ªç´€éŒ„ï¼Œä¸éœ€è¦æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²åˆ°è¨ª
                const visitRef = await db.collection('users').doc(userId)
                    .collection('visits')
                    .add({
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        scannedBy: currentUser.uid
                    });

                console.log('åˆ°è¨ªç´€éŒ„å·²æ–°å¢:', visitRef.id);
                await showCustomAlert('å·²æˆåŠŸå¢åŠ åˆ°è¨ªç´€éŒ„ï¼');
                
                // é‡æ–°è¼‰å…¥æœƒå“¡è©³æƒ…
                console.log('é‡æ–°è¼‰å…¥æœƒå“¡è©³æƒ…');
                await viewMemberDetails(userId);
            } catch (error) {
                console.error('å¢åŠ åˆ°è¨ªç´€éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('å¢åŠ åˆ°è¨ªç´€éŒ„å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ·»åŠ é¡¯ç¤ºå’Œéš±è—è¼‰å…¥å‹•ç•«çš„å‡½æ•¸
        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        // æ–°å¢æœƒå“¡åŠŸèƒ½
        async function addNewMember() {
            try {
                showLoading();
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
                const currentUser = auth.currentUser;
                if (!currentUser || currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–è¡¨å–®æ•¸æ“š
                const email = document.getElementById('newMemberEmail').value.trim();
                const name = document.getElementById('newMemberName').value.trim();
                const idNumber = document.getElementById('newMemberIdNumber').value.trim();
                const birthDate = document.getElementById('newMemberBirthDate').value;
                const phone = document.getElementById('newMemberPhone').value.trim();
                const nationality = document.getElementById('newMemberNationality').value.trim();

                // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆç§»é™¤ email çš„å¿…å¡«æª¢æŸ¥ï¼‰
                if (!name || !idNumber || !birthDate || !phone || !nationality) {
                    throw new Error('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼ˆé›»å­éƒµä»¶ç‚ºé¸å¡«ï¼‰');
                }

                // å¦‚æœæœ‰å¡«å¯« emailï¼Œå‰‡æª¢æŸ¥æ ¼å¼
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»å­éƒµä»¶åœ°å€');
                }

                // ç”Ÿæˆæœƒå“¡æ¢ç¢¼
                const timestamp = Date.now();
                const barcode = `MEM${timestamp}`;

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„è­‰ä»¶è™Ÿç¢¼
                const existingMemberQuery = await db.collectionGroup('data')
                    .where('idNumber', '==', idNumber)
                    .where('role', '==', 'customer')
                    .get();

                if (!existingMemberQuery.empty) {
                    throw new Error('æ­¤è­‰ä»¶è™Ÿç¢¼å·²è¢«è¨»å†Š');
                }

                // å‰µå»ºæ–°çš„æœƒå“¡æ–‡æª”
                const newMemberRef = db.collection('users').doc();
                await newMemberRef.collection('data').doc('profile').set({
                    role: 'customer',
                    email: email || '', // å¦‚æœæ²’æœ‰ email å‰‡è¨­ç‚ºç©ºå­—ä¸²
                    barcode: barcode,
                    name: name,
                    idNumber: idNumber,
                    birthDate: birthDate,
                    phone: phone,
                    nationality: nationality,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isInfoComplete: true
                });

                // æ¸…ç©ºè¡¨å–®
                document.getElementById('newMemberEmail').value = '';
                document.getElementById('newMemberName').value = '';
                document.getElementById('newMemberIdNumber').value = '';
                document.getElementById('newMemberBirthDate').value = '';
                document.getElementById('newMemberPhone').value = '';
                document.getElementById('newMemberNationality').value = '';

                await showCustomAlert(`æœƒå“¡æ–°å¢æˆåŠŸï¼\næœƒå“¡æ¢ç¢¼ï¼š${barcode}`);
            } catch (error) {
                console.error('æ–°å¢æœƒå“¡æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('æ–°å¢æœƒå“¡å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // æ–°å¢æœƒå“¡è¡¨å–®æ”¶åˆåŠŸèƒ½
        function toggleNewMemberForm() {
            const content = document.getElementById('newMemberForm');
            const icon = document.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
        }

        // æœƒå“¡æ¸…å–®ç›¸é—œè®Šæ•¸
        let currentPage = 1;
        const membersPerPage = 10;
        let totalMembers = 0;
        let allMembers = [];

        // åˆ‡æ›æœƒå“¡æ¸…å–®é¡¯ç¤º
        function toggleMemberList() {
            const content = document.getElementById('memberListContent');
            const icon = content.previousElementSibling.querySelector('.toggle-icon');
            content.classList.toggle('expanded');
            icon.classList.toggle('expanded');
            
            if (content.classList.contains('expanded')) {
                loadMemberList();
            }
        }

        // è¼‰å…¥æœƒå“¡æ¸…å–®
        async function loadMemberList() {
            try {
                showLoading();
                
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–æ‰€æœ‰æœƒå“¡è³‡æ–™
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                allMembers = await Promise.all(querySnapshot.docs.map(async doc => {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // ç²å–åˆ°è¨ªæ¬¡æ•¸
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    return {
                        ...userData,
                        userId: userId,
                        visitCount: visitsSnapshot.size
                    };
                }));

                totalMembers = allMembers.length;
                displayMemberList();
                updatePagination();
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('è¼‰å…¥æœƒå“¡æ¸…å–®å¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // é¡¯ç¤ºæœƒå“¡æ¸…å–®
        function displayMemberList() {
            const tbody = document.getElementById('memberListBody');
            tbody.innerHTML = '';
            
            const start = (currentPage - 1) * membersPerPage;
            const end = start + membersPerPage;
            const pageMembers = allMembers.slice(start, end);
            
            pageMembers.forEach(member => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${member.barcode || ''}</td>
                    <td>${member.name || ''}</td>
                    <td>${member.phone || ''}</td>
                    <td>${member.visitCount || 0}</td>
                    <td class="action-column">
                        <button class="view-btn" onclick="viewMemberDetails('${member.userId}')">æŸ¥çœ‹</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°åˆ†é æŒ‰éˆ•
        function updatePagination() {
            const pagination = document.getElementById('memberListPagination');
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            
            let paginationHTML = '';
            
            // ä¸Šä¸€é æŒ‰éˆ•
            paginationHTML += `
                <button onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    ä¸Šä¸€é 
                </button>
            `;
            
            // é ç¢¼æŒ‰éˆ•
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `
                    <button onclick="changePage(${i})" 
                            class="${currentPage === i ? 'active' : ''}">
                        ${i}
                    </button>
                `;
            }
            
            // ä¸‹ä¸€é æŒ‰éˆ•
            paginationHTML += `
                <button onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    ä¸‹ä¸€é 
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // åˆ‡æ›é é¢
        function changePage(page) {
            const totalPages = Math.ceil(totalMembers / membersPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            displayMemberList();
            updatePagination();
        }

        // è™•ç†æœå°‹æ¬„ä½çš„æŒ‰éµäº‹ä»¶
        function handleSearchKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                searchMember();
            }
        }

        // éŸ³æ•ˆåˆå§‹åŒ–
        const reminderSound = document.getElementById('reminderSound');
        const exportSound = document.getElementById('exportSound');

        // éŸ³æ•ˆæ’­æ”¾å‡½æ•¸
        function playReminderSound() {
            try {
                reminderSound.currentTime = 0;
                reminderSound.play().catch(error => {
                    console.log('æé†’éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('æé†’éŸ³æ•ˆæ’­æ”¾å‡ºéŒ¯:', error);
            }
        }

        function playExportSound() {
            try {
                exportSound.currentTime = 0;
                exportSound.play().catch(error => {
                    console.log('åŒ¯å‡ºéŸ³æ•ˆæ’­æ”¾å¤±æ•—:', error);
                });
            } catch (error) {
                console.log('åŒ¯å‡ºéŸ³æ•ˆæ’­æ”¾å‡ºéŒ¯:', error);
            }
        }

        // åœ¨é¡¯ç¤ºæé†’æ™‚æ’­æ”¾éŸ³æ•ˆ
        function showReminderDialog() {
            playReminderSound();
            // ... å…¶ä»–æé†’å°è©±æ¡†é¡¯ç¤ºé‚è¼¯ ...
        }

        // åœ¨åŒ¯å‡ºå®Œæˆæ™‚æ’­æ”¾éŸ³æ•ˆ
        function onExportComplete() {
            playExportSound();
            // ... å…¶ä»–åŒ¯å‡ºå®Œæˆé‚è¼¯ ...
        }

        // åŒ¯å‡ºæœƒå“¡è³‡æ–™åŠŸèƒ½
        async function exportMemberData() {
            try {
                showLoading();
                
                // æ’­æ”¾åŒ¯å‡ºéŸ³æ•ˆ
                playExportSound();
                
                // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
                if (auth.currentUser.uid !== 't4R9VmALi2SW2fTITmBAtlYDzq32') {
                    throw new Error('æ¬Šé™ä¸è¶³');
                }

                // ç²å–æ‰€æœ‰æœƒå“¡è³‡æ–™
                const querySnapshot = await db.collectionGroup('data')
                    .where('role', '==', 'customer')
                    .get();

                // æº–å‚™ TSV è³‡æ–™
                let tsvContent = 'æœƒå“¡æ¢ç¢¼\tå§“å\té›»è©±\té›»å­éƒµä»¶\tè­‰ä»¶è™Ÿç¢¼\tå‡ºç”Ÿå¹´æœˆæ—¥\tåœ‹ç±\tåˆ°è¨ªæ¬¡æ•¸\n';

                // è™•ç†æ¯å€‹æœƒå“¡çš„è³‡æ–™
                for (const doc of querySnapshot.docs) {
                    const userData = doc.data();
                    const userId = doc.ref.parent.parent.id;
                    
                    // ç²å–åˆ°è¨ªæ¬¡æ•¸
                    const visitsSnapshot = await db.collection('users')
                        .doc(userId)
                        .collection('visits')
                        .get();
                    
                    // å°‡è³‡æ–™åŠ å…¥ TSV
                    tsvContent += `${userData.barcode || ''}\t${userData.name || ''}\t${userData.phone || ''}\t${userData.email || ''}\t${userData.idNumber || ''}\t${userData.birthDate || ''}\t${userData.nationality || ''}\t${visitsSnapshot.size}\n`;
                }

                // å‰µå»º Blob ä¸¦ä¸‹è¼‰
                const blob = new Blob(['\ufeff' + tsvContent], { type: 'text/tab-separated-values;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `æœƒå“¡è³‡æ–™_${new Date().toLocaleDateString()}.tsv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                await showCustomAlert('æœƒå“¡è³‡æ–™åŒ¯å‡ºå®Œæˆï¼');
            } catch (error) {
                console.error('åŒ¯å‡ºæœƒå“¡è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                await showCustomAlert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
            } finally {
                hideLoading();
            }
        }

        // é¡¯ç¤ºæ’ç¨‹å°è©±æ¡†
        function showScheduleDialog() {
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            // è¨­ç½®å°è©±æ¡†å…§å®¹
            messageElement.innerHTML = `
                <h3>è¨­å®šæé†’æ™‚é–“</h3>
                <p>è«‹é¸æ“‡æ¯æ—¥æé†’æ™‚é–“ï¼š</p>
                <input type="time" id="reminderTime" value="${localStorage.getItem('reminderTime') || '09:00'}">
            `;
            
            // ä¿®æ”¹ç¢ºèªæŒ‰éˆ•
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = 'å„²å­˜è¨­å®š';
            
            // é¡¯ç¤ºå°è©±æ¡†
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
            confirmBtn.onclick = async () => {
                const time = document.getElementById('reminderTime').value;
                if (!time) {
                    await showCustomAlert('è«‹é¸æ“‡æé†’æ™‚é–“');
                    return;
                }
                
                // å„²å­˜è¨­å®š
                localStorage.setItem('reminderTime', time);
                setupReminder(time);
                
                // é—œé–‰å°è©±æ¡†
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                
                await showCustomAlert(`æé†’æ™‚é–“å·²è¨­å®šç‚º ${time}`);
            };
        }

        // è¨­ç½®æé†’
        function setupReminder(time) {
            // æ¸…é™¤ç¾æœ‰çš„æé†’
            if (window.reminderTimeout) {
                clearTimeout(window.reminderTimeout);
            }
            
            // è¨ˆç®—ä¸‹æ¬¡æé†’æ™‚é–“
            const [hours, minutes] = time.split(':').map(Number);
            const now = new Date();
            let next = new Date(now);
            next.setHours(hours, minutes, 0, 0);
            
            if (next <= now) {
                next.setDate(next.getDate() + 1);
            }
            
            // è¨­ç½®æé†’
            const delay = next.getTime() - now.getTime();
            window.reminderTimeout = setTimeout(() => {
                showReminderNotification();
                setupReminder(time); // è¨­ç½®ä¸‹ä¸€æ¬¡æé†’
            }, delay);
            
            console.log(`ä¸‹æ¬¡æé†’æ™‚é–“ï¼š${next.toLocaleString()}`);
        }

        // é¡¯ç¤ºæé†’é€šçŸ¥
        async function showReminderNotification() {
            playReminderSound();
            
            const alertOverlay = document.querySelector('.alert-overlay');
            const customAlert = document.querySelector('.custom-alert');
            const messageElement = customAlert.querySelector('.message');
            
            messageElement.innerHTML = `
                <h3>åŒ¯å‡ºæé†’</h3>
                <p>ç¾åœ¨æ˜¯å¦è¦åŒ¯å‡ºæœƒå“¡è³‡æ–™ï¼Ÿ</p>
            `;
            
            // ä¿®æ”¹æŒ‰éˆ•
            const confirmBtn = customAlert.querySelector('.confirm-btn');
            confirmBtn.textContent = 'ç«‹å³åŒ¯å‡º';
            
            // æ·»åŠ å»¶å¾ŒæŒ‰éˆ•
            const postponeBtn = document.createElement('button');
            postponeBtn.textContent = 'ç¨å¾Œæé†’';
            postponeBtn.className = 'confirm-btn';
            postponeBtn.style.marginLeft = '10px';
            postponeBtn.style.backgroundColor = '#6c757d';
            confirmBtn.parentNode.appendChild(postponeBtn);
            
            // é¡¯ç¤ºå°è©±æ¡†
            alertOverlay.style.display = 'block';
            customAlert.style.display = 'block';
            
            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            confirmBtn.onclick = async () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                await exportMemberData();
            };
            
            postponeBtn.onclick = () => {
                alertOverlay.style.display = 'none';
                customAlert.style.display = 'none';
                postponeBtn.remove();
                // 5 åˆ†é˜å¾Œå†æ¬¡æé†’
                setTimeout(showReminderNotification, 5 * 60 * 1000);
            };
        }

        // åœ¨ç™»å…¥å¾Œæ¢å¾©æé†’è¨­å®š
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const isStaff = await checkIfStaff(user.uid);
                if (isStaff) {
                    const savedTime = localStorage.getItem('reminderTime');
                    if (savedTime) {
                        setupReminder(savedTime);
                    }
                }
            }
        });
    </script>
</body>
</html>